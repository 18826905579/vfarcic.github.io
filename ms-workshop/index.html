<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Microservices Lifecycle</title>

		<meta name="author" content="Viktor Farcic">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/viktor.css" id="theme">

		<!-- Code syntax highlighting -->
		<!--<link rel="stylesheet" href="lib/css/zenburn.css">-->

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section id="cover">
					<h1>Microservices Lifecycle</h1>
					<p>
						<small>
							Created by <a href="http://technologyconversations.com/about/">Viktor Farcic</a>
							for <a href="http://technologyconversations.com">Technology Conversations</a> / <a href="http://twitter.com/vfarcic">@vfarcic</a>
						</small>
					</p>
				</section>
				<section id="about-me">
					<h2>Viktor Farcic</h2>
					<ul>
						<img src="img/viktor.jpg" style="float: right; width: 25%; height: 25%;"/>
						<li>Software Architect at <a href="http://everis.com">everis</a> an <a href="http://www.nttdata.com/">NTT DATA Company</a></li>
						<li>Never developed in Fortran</li>
						<li>Passionate about microservices, continuous deployment and TDD</li>
						<li>Blogger in <a href="http://technologyconversations.com/">TechnologyConversations.com</a> and speaker at conferences</li>
						<li><a href="http://www.amazon.com/Test-Driven-Java-Development-Viktor-Farcic-ebook/dp/B00YSIM3SC">Java Test-Driven Development: Mastering TDD Through Katas</a></li>
					</ul>
				</section>
				<section id="failures">
					<h2>History of the Failed Initiatives</h2>
					<h4>Continuous Integration (CI), Delivery and Deployment (CD)</h4>
					<ul>
						<li class="fragment">Integration phase = Dante's Infierno</li>
						<li class="fragment">eXtreme programming (XP)</li>
						<li class="fragment">Architecture</li>
						<li class="fragment">Testing</li>
						<li class="fragment">Orchestration</li>
						<li class="fragment">Deployments</li>
					</ul>
				</section>
				<section id="history">
					<h2>Things in Common</h2>
					<ul>
						<li class="fragment">Domain-driven design</li>
						<li class="fragment">Continuous integration/delivery/deployment</li>
						<li class="fragment">Containers</li>
						<li class="fragment">Small autonomous teams</li>
						<li class="fragment">Scalable systems</li>
					</ul>
				</section>
				<section>
					<section id="ci-cd">
						<h2>Continuous deployment</h2>
						<ul>
							<li class="fragment"><strong>Continuous integration</strong>
								<div>
									<label class="fragment">Push/clone,</label>
									<label class="fragment">Static analysis,</label>
									<label class="fragment">Pre-deployment testing,</label>
									<label class="fragment">Packaging/deployment,</label>
									<label class="fragment">Post-deployment testing</label>
								</div>
							</li>
							<li class="fragment"><strong>Continuous delivery</strong>
								<div>
									<label class="fragment">every commit <label class="fragment grow highlight-current-green">can be</label> deployed to production</label>
								</div>
							</li>
							<li class="fragment"><strong>Continuous deployment</strong>
								<div>
									<label class="fragment">every commit <label class="fragment grow highlight-current-green">is</label> deployed to production</label>
								</div>
							</li>
						</ul>
					</section>
					<section id="ci-process">
						<h4>Continuous deployment</h4>
						<h2>CI process</h2>
						<img src="img/ci-cd/ci.png" style="width: 65%; height: 65%;">
					</section>
					<section id="ci-pipeline">
						<h4>Continuous deployment</h4>
						<h2>CI pipeline</h2>
						<img src="img/ci-pipeline.png">
					</section>
					<section id="cd-process">
						<h4>Continuous deployment</h4>
						<h2>Continuous delivery process</h2>
						<img src="img/cd.png" style="width: 65%; height: 65%;">
					</section>
					<section id="cd-pipeline">
						<img src="img/cd-pipeline.png" style="width: 60%; height: 60%; float: right;">
						<h4>Continuous deployment</h4>
						<h2>Continuous deployment pipeline</h2>
					</section>
				</section>
				<section>
					<section id="containers">
						<h2>Containers (Docker)</h2>
						<blockquote>Shipping container is an object for holding or transporting something</blockquote>
						<img src="img/docker.png" style="float: right; width: 40%; height: 40%; background-color: white;">
						<ul>
							<li class="fragment">Isolated</li>
							<li class="fragment">Immutable</li>
							<li class="fragment">Reliable</li>
							<li class="fragment">Self-sufficient</li>
							<li class="fragment">Scalable</li>
						</ul>
					</section>
					<section id="containers-vms">
						<h4>Containers (Docker)</h4>
						<h2>VMs vs Containers</h2>
						<img src="img/containers-vms.png" style="width: 85%; height: 85%;">
					</section>
					<section id="container-self-sufficient">
						<h4>Containers (Docker)</h4>
						<h2>Self-sufficient container</h2>
						<img src="img/container.png" style="width: 60%; height: 60%;">
					</section>
					<section id="container-db">
						<h4>Containers (Docker)</h4>
						<h2>Container with the separate DB</h2>
						<img src="img/container-db.png" style="width: 90%; height: 90%; ">
					</section>
					<section id="container-shared-db">
						<h4>Containers (Docker)</h4>
						<h2>Containers with the shared DB</h2>
						<img src="img/container-shared-db.png" style="width: 70%; height: 70%; ">
					</section>
				</section>
				<section>
					<section id="monolith" data-background="img/monolith/monolith.jpg">
						<h2>Monolithic applications</h2>
						<ul>
							<li class="fragment">Single unit</li>
							<li class="fragment">Time increases complexity and size</li>
							<li class="fragment">Time decreases development, testing and deployment speed</li>
							<li class="fragment">Layers</li>
							<li class="fragment">Change is hard and with risks</li>
							<li class="fragment">Scaling = multiplication of the entire application</li>
						</ul>
					</section>
					<section id="monolith-simple">
						<h4>Monolithic applications</h4>
						<h2>Early</h2>
						<img src="img/monolith/monolith.png">
					</section>
					<section id="monolith-features">
						<h4>Monolithic applications</h4>
						<h2>Later</h2>
						<img src="img/monolith/monolith-features.png">
					</section>
					<section id="monolith-scaling">
						<h4>Monolithic applications</h4>
						<h2>Scaling</h2>
						<img src="img/monolith/monolith-scaling.png" style="width: 80%; height: 80%;">
					</section>
				</section>
				<section>
					<section id="ms" data-background="img/code.jpg">
						<h2>Microservices</h2>
						<h4>Applications that fit into a screen</h4>
						<ul>
							<li class="fragment">System composed of small services</li>
							<li class="fragment">Autonomy/independence</li>
							<li class="fragment">Data exchange through APIs</li>
							<li class="fragment">Bounded context</li>
						</ul>
					</section>
					<section id="ms-diagram">
						<h4>Microservices</h4>
						<h2>Self-Sufficiency</h2>
						<img src="img/ms/microservices.png">
					</section>
					<section id="ms-gartner">
						<h4>Microservices</h4>
						<h2>Gartner</h2>
						<blockquote>
							Microservices are simpler, developers get more productive and systems can be scaled quickly and precisely, rather than in large monolithic globs. And I havenâ€™t even mentioned the potential for polyglot coding and data persistence.
							<br/><div style="float: right;">- Gary Olliffe </div>
						</blockquote>
					</section>
					<section id="ms-ood">
						<h4>Microservices</h4>
						<h2>Object-Oriented Design</h2>
						<blockquote>
							The big idea is 'messaging'.
							The key in making great and growable systems is much more to design how its modules communicate rather than what their internal properties and behaviors should be.
							<br/><div style="float: right;">- Alan Kay</div>
						</blockquote>
					</section>
					<section id="ms-srp">
						<h4>Microservices</h4>
						<h2>Single Responsibility Principle</h2>
						<blockquote>
							Gather together those things that change for the same reason, and separate those things that change for different reasons
							<div style="float: right;">- Robert C. Martin</div>
						</blockquote>
					</section>
					<section id="ms-linux">
						<h4>Microservices</h4>
						<h2>Linux = Microservices</h2>
                    	<pre><code data-trim contenteditable>
ps aux | grep jav[a] | awk '{print $2}' | xargs kill
						</code></pre>
					</section>
				</section>
				<section id="ms-keys">
					<h2>Microservices</h2>
					<h3>Key Aspects</h3>
					<ul>
						<li class="fragment">One thing or one functionality</li>
						<li class="fragment">Any tools or languages</li>
						<li class="fragment">Truly loosely coupled</li>
						<li class="fragment">Teams independence</li>
						<li class="fragment">Easier testing and CD</li>
						<li class="fragment">Decentralization</li>
					</ul>
				</section>
				<section id="ms-cons">
					<h2>Microservices</h2>
					<h4>Disadvantages</h4>
					<ul>
						<li class="fragment">Increased operational and deployment complexity
							<ul>
								<li class="fragment">Configuration Management</li>
								<li class="fragment">Containers (Docker)</li>
								<li class="fragment">Work shifted from development to DevOps</li>
							</ul>
						</li>
						<li class="fragment">Remote process calls</li>
					</ul>
				</section>
				<section id="ms-pros">
					<h2>Microservices</h2>
					<h4>Advantages</h4>
					<ul>
						<li class="fragment">Scaling</li>
						<li class="fragment">Resilience / fault isolation</li>
						<li class="fragment">Innovation</li>
						<li class="fragment">Size</li>
						<li class="fragment">Decoupling</li>
						<li class="fragment">Deployment</li>
						<li class="fragment">No need for long term commitment</li>
					</ul>
				</section>
				<section id="ms-bp">
					<h2>Microservices</h2>
					<h4>Best Practices</h4>
					<ul>
						<li class="fragment">Containers (Docker)</li>
						<li class="fragment">Reverse proxy</li>
						<li class="fragment">Minimalist approach</li>
						<li class="fragment">CM is a must</li>
						<li class="fragment">Cross functional teams</li>
						<li class="fragment">API versioning</li>
					</ul>
				</section>
				<section>
					<section id="deployment">
						<h2>Deployment</h2>
						<ul>
							<li class="fragment">Big vs small</li>
							<li class="fragment">Mutable vs immutable</li>
						</ul>
					</section>
					<section id="deployment-mutable">
						<h3>Deployment</h3>
						<h2>Mutable Monster Server</h2>
						<div>
							<img src="img/deployment/mutable-application-server.png">
						</div>
					</section>
					<section id="deployment-immutable-server-01" data-transition="fade-in slide-out">
						<h3>Deployment</h3>
						<h2>Immutable Server</h2>
						<div>
							<img src="img/deployment/immutable-application-server-01.png">
						</div>
					</section>
					<section id="deployment-immutable-server-02" data-transition="fade-in slide-out">
						<h3>Deployment</h3>
						<h2>Immutable Server</h2>
						<div>
							<img src="img/deployment/immutable-application-server-02.png">
						</div>
					</section>
					<section id="deployment-immutable-server-03" data-transition="fade-in slide-out">
						<h3>Deployment</h3>
						<h2>Immutable Server</h2>
						<div>
							<img src="img/deployment/immutable-application-server-03.png">
						</div>
					</section>
					<section id="deployment-immutable-server-04" data-transition="fade-in slide-out">
						<h3>Deployment</h3>
						<h2>Immutable Server</h2>
						<div>
							<img src="img/deployment/immutable-application-server-04.png">
						</div>
					</section>
					<section id="deployment-immutable-ms-01" data-transition="fade-in slide-out">
						<h3>Deployment</h3>
						<h2>Immutable Micro Services</h2>
						<div>
							<img src="img/deployment/immutable-microservices-01.png">
						</div>
					</section>
					<section id="deployment-immutable-ms-02" data-transition="fade-in slide-out">
						<h3>Deployment</h3>
						<h2>Immutable Micro Services</h2>
						<div>
							<img src="img/deployment/immutable-microservices-02.png">
						</div>
					</section>
					<section id="deployment-immutable-ms-03" data-transition="fade-in slide-out">
						<h3>Deployment</h3>
						<h2>Immutable Micro Services</h2>
						<div>
							<img src="img/deployment/immutable-microservices-03.png">
						</div>
					</section>
					<section id="deployment-immutable-ms-04" data-transition="fade-in slide-out">
						<h3>Deployment</h3>
						<h2>Immutable Micro Services</h2>
						<div>
							<img src="img/deployment/immutable-microservices-04.png">
						</div>
					</section>
				</section>
				<section>
					<section id="dev">
						<h2>Development Environment</h2>
						<ul>
							<li class="fragment">Vagrant</li>
							<li class="fragment">Docker</li>
						</ul>
					</section>
					<section id="dev-vm">
						<h4>Development Environment</h4>
						<h2>Create Virtual Machine</h2>
						Please skip the first two steps if you followed the workshop preparation instructions.
						<pre><code data-trim contenteditable>
git clone https://github.com/vfarcic/books-ms.git

vagrant plugin install vagrant-cachier

cd books-ms
						</code></pre>
					</section>
					<section id="dev-vagrantfile">
						<h4>Development Environment</h4>
						<h2>Vagrantfile</h2>
						<pre><code data-trim contenteditable>
cat Vagrantfile

vagrant up dev
						</code></pre>
					</section>
					<section id="dev-inside-vm">
						<h4>Development Environment</h4>
						<h2>Inside the Virtual Machine</h2>
						<pre><code data-trim contenteditable>
vagrant ssh dev

ansible --version

docker --version

docker-compose --version

cd /vagrant

ll
						</code></pre>
					</section>
					<section id="dev-fe-tests">
						<h4>Development Environment</h4>
						<h2>Front-end tests</h2>
						<pre><code data-trim contenteditable>
sudo docker run -it --rm \
	-v $PWD/client/components:/source/client/components \
	-v $PWD/client/test:/source/client/test \
	-v $PWD/src:/source/src \
	-v $PWD/target:/source/target \
	-v /data/tests/db:/data/db \
	-p 8080:8080 \
	--env TEST_TYPE=watch-front \
	vfarcic/books-ms-tests
						</code></pre>
						Press <strong>CTRL+c</strong> to stop the container.
					</section>
					<section id="dev-fe-tests-compose">
						<h4>Development Environment</h4>
						<h2>Tests with Docker Compose</h2>
						<pre><code data-trim contenteditable>
sudo docker-compose -f docker-compose-dev.yml up feTestsLocal

sudo docker-compose -f docker-compose-dev.yml run testsLocal
						</code></pre>
					</section>
					<section id="dev-stop-vm">
						<h4>Development Environment</h4>
						<h2>Stop the VM</h2>
						<pre><code data-trim contenteditable>
exit

vagrant halt dev
						</code></pre>
					</section>
				</section>
				<section>
					<section id="dp">
						<h2>Deployment Pipeline</h2>
						<ol>
							<img src="img/dp/cd-pipeline-docker-no-ansible.png" style="float: right; width: 50%; height: 50%;">
							<li class="fragment">Checkout the code</li>
							<li class="fragment">Run pre-deployment tests</li>
							<li class="fragment">Compile and/or package the code</li>
							<li class="fragment">Build the container</li>
							<li class="fragment">Push the container to the registry</li>
							<li class="fragment">Deploy the container to the production server</li>
							<li class="fragment">Integrate the container</li>
							<li class="fragment">Run post-deployment tests</li>
							<li class="fragment">Push the tests container to the registry</li>
						</ol>
					</section>
					<section id="dp-env">
						<h4>Deployment Pipeline: Initial Stages</h4>
						<h2>Creating the CD VM</h2>
						Please skip the <strong>git clone</strong> step if you followed the workshop preparation instructions.
						<pre><code data-trim contenteditable>
cd ..

git clone https://github.com/vfarcic/ms-lifecycle.git

cd ms-lifecycle

vagrant up cd

vagrant ssh cd
						</code></pre>
					</section>
					<section id="dp-checkout">
						<h4>Deployment Pipeline: Initial Stages</h4>
						<h2>Checking out the code</h2>
						Please skip the <strong>git clone</strong> step if you followed the workshop preparation instructions.
						<pre><code data-trim contenteditable>
git clone https://github.com/vfarcic/books-ms.git

cd books-ms
						</code></pre>
					</section>
					<section id="dp-pre-deployment-tests">
						<h4>Deployment Pipeline: Initial Stages</h4>
						<h2>Running pre-deployment tests and compiling and/or packaging the code</h2>
						<pre><code data-trim contenteditable>
sudo docker-compose -f docker-compose-dev.yml run --rm testsLocal

ll target/scala-2.10/
						</code></pre>
					</section>
					<section id="dp-building">
						<h4>Deployment Pipeline: Initial Stages</h4>
						<h2>Building Docker containers</h2>
						<pre><code data-trim contenteditable>
cat Dockerfile

sudo docker build -t vfarcic/books-ms .
						</code></pre>
					</section>
					<section id="dp-running-1">
						<h4>Deployment Pipeline: Initial Stages</h4>
						<h2>Running containers (Docker)</h2>
						<h3>Docker</h3>
						<pre><code data-trim contenteditable>
sudo docker pull mongo

sudo docker tag mongo 10.100.198.200:5000/mongo

sudo docker push 10.100.198.200:5000/mongo

sudo docker run -d --name books-ms-db \
	10.100.198.200:5000/mongo

sudo docker run -d --name books-ms \
	-p 8080:8080 \
	--link books-ms-db:db \
	vfarcic/books-ms

sudo docker exec -it books-ms bash

env | grep DB

exit

sudo docker ps -a

sudo docker logs books-ms

sudo docker rm -f books-ms books-ms-db

sudo docker ps -a
						</code></pre>
					</section>
					<section id="dp-running-2">
						<h4>Deployment Pipeline: Initial Stages</h4>
						<h2>Running containers</h2>
						<h3>Docker Compose</h3>
						<pre><code data-trim contenteditable>
sudo docker-compose -f docker-compose-dev.yml up -d appLocal

cat docker-compose-dev.yml

sudo docker-compose ps

sudo docker ps -a

sudo docker logs booksms_appLocal_1
						</code></pre>
					</section>
					<section id="dp-running-3">
						<h4>Deployment Pipeline: Initial Stages</h4>
						<h2>Running containers</h2>
						<h3>cURL</h3>
						<pre><code data-trim contenteditable>
curl -H 'Content-Type: application/json' -X PUT -d \
	'{"_id": 1,
	"title": "My First Book",
	"author": "John Doe",
	"description": "Not a very good book"}' \
	http://localhost:8080/api/v1/books | python -mjson.tool

curl -H 'Content-Type: application/json' -X PUT -d \
	'{"_id": 2,
	"title": "My Second Book",
	"author": "John Doe",
	"description": "Not a bad as the first book"}' \
	http://localhost:8080/api/v1/books | python -mjson.tool

curl -H 'Content-Type: application/json' -X PUT -d \
	'{"_id": 3,
	"title": "My Third Book",
	"author": "John Doe",
	"description": "Failed writers club"}' \
	http://localhost:8080/api/v1/books | python -mjson.tool

curl http://localhost:8080/api/v1/books | python -mjson.tool

curl http://localhost:8080/api/v1/books/_id/1 | python -mjson.tool

sudo docker rm -f booksms_app_1 booksms_db_1
						</code></pre>
					</section>
					<section id="dp-registry">
						<h4>Deployment Pipeline: Initial Stages</h4>
						<h2>Pushing containers to the registry</h2>
						<pre><code data-trim contenteditable>
sudo docker tag vfarcic/books-ms \
	10.100.198.200:5000/books-ms

sudo docker push 10.100.198.200:5000/books-ms

sudo docker tag vfarcic/books-ms-tests \
	10.100.198.200:5000/books-ms-tests

sudo docker push 10.100.198.200:5000/books-ms-tests

exit
						</code></pre>
					</section>
					<section id="dp-checklist">
						<h4>Deployment Pipeline: Initial Stages</h4>
						<h2>Checklist</h2>
						<ol>
							<img src="img/dp/cd-pipeline-docker-initial.png" style="float: right; width: 50%; height: 50%;">
							<li class="fragment"><del>Checkout the code</del></li>
							<li class="fragment"><del>Run pre-deployment tests</del></li>
							<li class="fragment"><del>Compile and/or package the code</del></li>
							<li class="fragment"><del>Build the container</del></li>
							<li class="fragment"><del>Push the container to the registry</del></li>
							<li class="fragment">Deploy the container to the production server</li>
							<li class="fragment">Integrate the container</li>
							<li class="fragment">Run post-deployment tests</li>
							<li class="fragment">Push the tests container to the registry</li>
						</ol>
					</section>
				</section>
				<section>
					<section id="cm">
						<h2>Configuration Management in the Docker World</h2>
						<table>
							<tr>
								<td class="fragment" style="width: 24%;">
									<img src="img/cm/cfengine.png" style="background-color: white;">
								</td>
								<td class="fragment" style="width: 24%;">
									<img src="img/cm/puppet.png" style="background-color: white;">
								</td>
								<td class="fragment" style="width: 24%;">
									<img src="img/cm/chef.png" style="background-color: white;">
								</td>
								<td class="fragment" style="width: 24%;">
									<img src="img/cm/ansible.png" style="background-color: white;">
								</td>
							</tr>
						</table>
					</section>
					<section id="cm-prod">
						<h4>Configuration Management in the Docker World</h4>
						<h2>Configuring the Production Environment</h2>
						<pre><code data-trim contenteditable>
vagrant ssh cd

cd /vagrant/ansible

ansible-playbook prod.yml -i hosts/prod

ansible-playbook prod.yml -i hosts/prod
						</code></pre>
					</section>
					<section id="cm-playbook">
						<h4>Configuration Management in the Docker World</h4>
						<h2>Production environment Ansible playbook</h2>
						<pre><code data-trim contenteditable>
cat prod.yml

cat roles/docker/tasks/main.yml

cat roles/docker-compose/tasks/main.yml

cat hosts/prod

exit
						</code></pre>
					</section>
				</section>
				<section>
					<section id="dp2">
						<h2>Deployment Pipeline: Intermediate Stages</h2>
						<ol>
							<img src="img/dp/cd-pipeline-docker-initial.png" style="float: right; width: 50%; height: 50%;">
							<li class="fragment"><del>Checkout the code</del></li>
							<li class="fragment"><del>Run pre-deployment tests</del></li>
							<li class="fragment"><del>Compile and/or package the code</del></li>
							<li class="fragment"><del>Build the container</del></li>
							<li class="fragment"><del>Push the container to the registry</del></li>
							<li class="fragment">Deploy the container to the production server</li>
							<li class="fragment">Integrate the container</li>
							<li class="fragment">Run post-deployment tests</li>
							<li class="fragment">Push the tests container to the registry</li>
						</ol>
					</section>
					<section id="dp2-deploy">
						<h4>Deployment Pipeline: Intermediate Stages</h4>
						<h2>Deploying containers to the production server</h2>
						<pre><code data-trim contenteditable>
vagrant ssh prod

wget https://raw.githubusercontent.com/vfarcic\
/books-ms/master/docker-compose.yml

cat docker-compose.yml

sudo docker-compose up -d app
						</code></pre>
					</section>
					<section id="dp2-verification">
						<h4>Deployment Pipeline: Intermediate Stages</h4>
						<h2>Post-deployment verification</h2>
						<pre><code data-trim contenteditable>
sudo docker inspect vagrant_app_1

PORT=$(sudo docker inspect \
	--format='{{(index (index .NetworkSettings.Ports "8080/tcp") 0).HostPort}}' \
	vagrant_app_1)
	echo $PORT

curl -H 'Content-Type: application/json' -X PUT -d \
	"{\"_id\": 1,
	\"title\": \"My First Book\",
	\"author\": \"John Doe\",
	\"description\": \"Not a very good book\"}" \
	http://localhost:$PORT/api/v1/books | python -mjson.tool

curl -H 'Content-Type: application/json' -X PUT -d \
	"{\"_id\": 2,
	\"title\": \"My Second Book\",
	\"author\": \"John Doe\",
	\"description\": \"Not a bad as the first book\"}" \
	http://localhost:$PORT/api/v1/books | python -mjson.tool

curl -H 'Content-Type: application/json' -X PUT -d \
	"{\"_id\": 3,
	\"title\": \"My Third Book\",
	\"author\": \"John Doe\",
	\"description\": \"Failed writers club\"}" \
	http://localhost:$PORT/api/v1/books | python -mjson.tool

curl http://localhost:$PORT/api/v1/books | python -mjson.tool

curl http://localhost:$PORT/api/v1/books/_id/1 | python -mjson.tool
						</code></pre>
					</section>
					<section id="dp2-exit">
						<h4>Deployment Pipeline: Intermediate Stages</h4>
						<h2>Stopping Production Node</h2>
						<pre><code data-trim contenteditable>
exit

vagrant halt prod
						</code></pre>
					</section>
					<section id="dp2-checklist">
						<h4>Deployment Pipeline: Intermediate Stages</h4>
						<h2>Checklist</h2>
						<ol>
							<img src="img/dp/cd-pipeline-docker-intermediate.png" style="float: right; width: 50%; height: 50%;">
							<li class="fragment"><del>Checkout the code</del></li>
							<li class="fragment"><del>Run pre-deployment tests</del></li>
							<li class="fragment"><del>Compile and/or package the code</del></li>
							<li class="fragment"><del>Build the container</del></li>
							<li class="fragment"><del>Push the container to the registry</del></li>
							<li class="fragment"><del>Deploy the container to the production server</del></li>
							<li class="fragment">Integrate the container</li>
							<li class="fragment">Run post-deployment tests</li>
							<li class="fragment">Push the tests container to the registry</li>
						</ol>
					</section>
				</section>
				<section>
					<section id="sd">
						<h2>Service Discovery</h2>
						<img src="img/sd/service-discovery.png">
					</section>
					<section id="sd-single-node">
						<h4>Service Discovery</h4>
						<h2>Single node</h2>
						<img src="img/sd/single-node-docker.png">
					</section>
					<section id="sd-multi-node">
						<h4>Service Discovery</h4>
						<h2>Multiple nodes</h2>
						<img src="img/sd/multi-node-docker.png">
					</section>
					<section id="sd-tools">
						<h4>Service Discovery</h4>
						<h2>Tools</h2>
						<ol>
							<li class="fragment">Manual configuration</li>
							<li class="fragment">Zookeeper</li>
							<li class="fragment">etcd / Registrator / confd</li>
							<li class="fragment">
								<label class="fragment grow highlight-current-green">Consul / Registrator / Consul Template</label>
							</li>
						</ol>
					</section>
					<section id="sd-consul-playbook">
						<h4>Service Discovery</h4>
						<h2>Consul Ansible playbook</h2>
						<pre><code data-trim contenteditable>
vagrant up serv-disc-01 serv-disc-02 serv-disc-03

vagrant ssh cd

cat /vagrant/ansible/hosts/serv-disc

cat /vagrant/ansible/roles/consul/tasks/main.yml

cat /vagrant/ansible/roles/consul/defaults/main.yml

cat /vagrant/ansible/host_vars/10.100.197.201

cat /vagrant/ansible/consul.yml
						</code></pre>
					</section>
					<section id="sd-consul-setup">
						<h4>Service Discovery</h4>
						<h2>Setting up Consul</h2>
						<pre><code data-trim contenteditable>
ansible-playbook \
	/vagrant/ansible/consul.yml \
	-i /vagrant/ansible/hosts/serv-disc

curl 10.100.197.201:8500/v1/catalog/nodes \
	| python -mjson.tool
						</code></pre>
					</section>
					<section id="sd-consul-diagram">
						<h4>Service Discovery</h4>
						<h2>Consul</h2>
						<img src="img/consul.png">
					</section>
					<section id="sd-kv-put">
						<h4>Service Discovery</h4>
						<h2>Key/value store: PUT</h2>
						<pre><code data-trim contenteditable>
curl -X PUT -d 'this is a test' \
	http://10.100.197.201:8500/v1/kv/msg1

curl -X PUT -d 'this is another test' \
	http://10.100.197.202:8500/v1/kv/messages/msg2

curl -X PUT -d 'this is a test with flags' \
	http://10.100.197.203:8500/v1/kv/messages/msg3?flags=1234
						</code></pre>
					</section>
					<section id="sd-kv-get-delete">
						<h4>Service Discovery</h4>
						<h2>Key/value store: GET/DELETE</h2>
						<pre><code data-trim contenteditable>
curl http://10.100.197.203:8500/v1/kv/?recurse \
	| python -mjson.tool

curl http://10.100.197.202:8500/v1/kv/msg1 \
	| python -mjson.tool

curl http://10.100.197.201:8500/v1/kv/msg1?raw

curl -X DELETE http://10.100.197.201:8500/v1/kv/messages/msg2

curl -X DELETE http://10.100.197.202:8500/v1/kv/?recurse
						</code></pre>
					</section>
					<section id="sd-registrator-playbook">
						<h4>Service Discovery</h4>
						<h2>Registrator Ansible playbook</h2>
						<pre><code data-trim contenteditable>
sudo docker pull gilderlabs/registrator

sudo docker tag gilderlabs/registrator 10.100.198.200:5000/registrator

sudo docker push 10.100.198.200:5000/registrator

cat /vagrant/ansible/roles/registrator/tasks/main.yml

cat /vagrant/ansible/roles/registrator/defaults/main.yml
						</code></pre>
					</section>
					<section id="sd-registrator-setup">
						<h4>Service Discovery</h4>
						<h2>Setting up Registrator</h2>
						<pre><code data-trim contenteditable>
ansible-playbook \
	/vagrant/ansible/registrator.yml \
	-i /vagrant/ansible/hosts/serv-disc
						</code></pre>
					</section>
					<section id="sd-consul-registrator-diagram">
						<h4>Service Discovery</h4>
						<h2>Consul / Registrator</h2>
						<img src="img/consul-registrator.png">
					</section>
					<section id="sd-nginx">
						<h4>Service Discovery</h4>
						<h2>Registering service</h2>
						<pre><code data-trim contenteditable>
exit # Exit cd

vagrant ssh serv-disc-01

sudo docker run -d --name nginx \
	--env SERVICE_NAME=nginx \
	--env SERVICE_ID=nginx \
	-p 1234:80 \
	nginx

curl http://10.100.197.201:8500/v1/catalog/service/nginx \
	| python -mjson.tool
						</code></pre>
					</section>
					<section id="sd-nginx2">
						<h4>Service Discovery</h4>
						<h2>Registering service again</h2>
						<pre><code data-trim contenteditable>
sudo docker run -d --name nginx2 \
	--env "SERVICE_ID=nginx2" \
	--env "SERVICE_NAME=nginx" \
	--env "SERVICE_TAGS=balancer,proxy,www" \
	-p 1111:80 \
	nginx

curl http://localhost:8500/v1/catalog/service/nginx \
	| python -mjson.tool
						</code></pre>
					</section>
					<section id="sd-consul-template-playbook">
						<h4>Service Discovery</h4>
						<h2>Consul Template Ansible playbook</h2>
						<pre><code data-trim contenteditable>
exit

vagrant ssh cd

cat /vagrant/ansible/roles/consul-template/tasks/main.yml

cat /vagrant/ansible/consul-template.yml
						</code></pre>
					</section>
					<section id="sd-consul-template-setup">
						<h4>Service Discovery</h4>
						<h2>Setting Up Consul Template</h2>
						<pre><code data-trim contenteditable>
ansible-playbook \
	/vagrant/ansible/consul-template.yml \
	-i /vagrant/ansible/hosts/serv-disc
						</code></pre>
					</section>
					<section id="sd-consul-registrator-consul-template-diagram">
						<h4>Service Discovery</h4>
						<h2>Consul / Registrator / Consul Template</h2>
						<img src="img/consul-registrator-consul-template.png">
					</section>
					<section id="sd-consul-template-run">
						<h4>Service Discovery</h4>
						<h2>Running Consul Template</h2>
						<pre><code data-trim contenteditable>
exit # Exit cd node

vagrant ssh serv-disc-01 # Enter serv-disc-01

curl http://localhost:8500/v1/catalog/service/nginx \
	| python -mjson.tool

cat /data/consul-template/example.ctmpl

consul-template \
	-consul localhost:8500 \
	-template "/data/consul-template/example.ctmpl:/tmp/example.conf" \
	-once

cat /tmp/example.conf
						</code></pre>
					</section>
					<section id="sd-cleanup">
						<h4>Service Discovery</h4>
						<h2>Cleanup</h2>
						<pre><code data-trim contenteditable>
exit # Exit cd node

vagrant halt serv-disc-01 serv-disc-02 serv-disc-03
						</code></pre>
					</section>
				</section>
				<section>
					<section id="proxy">
						<h2>Proxy Service</h2>
						<img src="img/ms/microservices.png">
					</section>
					<section id="proxy-playbook">
						<h4>Proxy Service</h4>
						<h2>nginx Ansible Playbook</h2>
						<pre><code data-trim contenteditable>
vagrant up proxy

vagrant ssh cd

sudo docker pull nginx

sudo docker tag nginx 10.100.198.200:5000/nginx

sudo docker push 10.100.198.200:5000/nginx

cat /vagrant/ansible/nginx.yml

cat /vagrant/ansible/roles/nginx/tasks/main.yml

cat /vagrant/ansible/roles/nginx/files/services.conf

ansible-playbook /vagrant/ansible/nginx.yml \
	-i /vagrant/ansible/hosts/proxy

exit

vagrant ssh proxy

sudo docker ps
						</code></pre>
					</section>
					<section id="proxy-without">
						<h4>Proxy Service</h4>
						<h2>Services Without Proxy</h2>
						<pre><code data-trim contenteditable>
wget https://raw.githubusercontent.com/vfarcic\
/books-ms/master/docker-compose.yml

cat docker-compose.yml

sudo docker-compose up -d app

curl http://localhost/api/v1/books

sudo docker ps | grep books

PORT=$(sudo docker inspect \
	--format='{{(index (index .NetworkSettings.Ports "8080/tcp") 0).HostPort}}' \
	vagrant_app_1)

echo $PORT

curl http://localhost:$PORT/api/v1/books \
	| python -mjson.tool
						</code></pre>
					</section>
					<section id="proxy-without-diagram">
						<h4>Proxy Service</h4>
						<h2>Services Without Proxy</h2>
						<img src="img/proxy/proxy-without.png">
					</section>
					<section id="proxy-manual">
						<h4>Proxy Service</h4>
						<h2>Manually Setting Proxy</h2>
						<pre><code data-trim contenteditable>
echo "
location /api/v1/books {
	proxy_pass http://10.100.196.200:$PORT/api/v1/books;
}
" | sudo tee /data/nginx/includes/books-ms.conf

sudo docker kill -s HUP nginx

curl http://localhost/api/v1/books | python -mjson.tool

curl -H 'Content-Type: application/json' -X PUT -d \
	"{\"_id\": 1,
	\"title\": \"My First Book\",
	\"author\": \"John Doe\",
	\"description\": \"Not a very good book\"}" \
	http://localhost/api/v1/books | python -mjson.tool

curl http://localhost/api/v1/books | python -mjson.tool
						</code></pre>
					</section>
					<section id="proxy-manual-diagram">
						<h4>Proxy Service</h4>
						<h2>Manually Setting Proxy</h2>
						<img src="img/proxy/proxy-manual.png" style="width: 75%; height: 75%;">
					</section>
					<section id="proxy-consul">
						<h4>Proxy Service</h4>
						<h2>Configuring Proxy with Consul</h2>
						<pre><code data-trim contenteditable>
sudo docker-compose scale app=2

sudo docker ps | grep books

sudo wget http://raw.githubusercontent.com/vfarcic\
/books-ms/master/nginx-includes.conf \
	-O /data/nginx/includes/books-ms.conf

cat /data/nginx/includes/books-ms.conf

sudo wget http://raw.githubusercontent.com/vfarcic\
/books-ms/master/nginx-upstreams.ctmpl \
	-O /data/nginx/upstreams/books-ms.ctmpl

cat /data/nginx/upstreams/books-ms.ctmpl

sudo consul-template \
	-consul localhost:8500 \
	-template "/data/nginx/upstreams/books-ms.ctmpl:\
/data/nginx/upstreams/books-ms.conf:\
docker kill -s HUP nginx" \
	-once

cat /data/nginx/upstreams/books-ms.conf

curl http://localhost/api/v1/books | python -mjson.tool

curl http://localhost/api/v1/books | python -mjson.tool

curl http://localhost/api/v1/books | python -mjson.tool

curl http://localhost/api/v1/books | python -mjson.tool

sudo docker logs nginx
						</code></pre>
					</section>
					<section id="proxy-consul-diagram">
						<h4>Proxy Service</h4>
						<h2>Configuring Proxy with Consul</h2>
						<img src="img/proxy/proxy-consul.png">
					</section>
					<section id="proxy-cleanup">
						<h4>Proxy Service</h4>
						<h2>Cleanup</h2>
						<pre><code data-trim contenteditable>
exit

vagrant halt proxy
						</code></pre>
					</section>
				</section>
				<section>
					<section id="dp-late">
						<h2>Deployment Pipeline: The Late Stages</h2>
						<ol>
							<img src="img/dp/cd-pipeline-docker-intermediate.png" style="float: right; width: 50%; height: 50%;">
							<li class="fragment"><del>Checkout the code</del></li>
							<li class="fragment"><del>Run pre-deployment tests</del></li>
							<li class="fragment"><del>Compile and/or package the code</del></li>
							<li class="fragment"><del>Build the container</del></li>
							<li class="fragment"><del>Push the container to the registry</del></li>
							<li class="fragment"><del>Deploy the container to the production server</del></li>
							<li class="fragment">Integrate the container</li>
							<li class="fragment">Run post-deployment tests</li>
							<li class="fragment">Push the tests container to the registry</li>
						</ol>
					</section>
					<section id="dp-late-provision">
						<h4>Deployment Pipeline: The Late Stages</h4>
						<h2>Provision Production</h2>
						<pre><code data-trim contenteditable>
vagrant up prod --provision

vagrant ssh cd

cd /vagrant/ansible

cat prod2.yml

ansible-playbook prod2.yml -i hosts/prod

exit
						</code></pre>
					</section>
					<section id="dp-late-run">
						<h4>Deployment Pipeline: The Late Stages</h4>
						<h2>Run Containainers</h2>
						<pre><code data-trim contenteditable>
vagrant ssh prod

sudo docker start vagrant_db_1

sudo docker start vagrant_app_1

curl 10.100.198.201:8500/v1/catalog/service/books-ms \
	| python -mjson.tool
						</code></pre>
						Open <a href="http://10.100.198.201:8500/ui">http://10.100.198.201:8500/ui</a>.
					</section>
					<section id="dp-late-proxy">
						<h4>Deployment Pipeline: The Late Stages</h4>
						<h2>Update the Proxy Service</h2>
						<pre><code data-trim contenteditable>
curl http://localhost/api/v1/books

sudo wget https://raw.githubusercontent.com/vfarcic\
/books-ms/master/nginx-includes.conf \
	-O /data/nginx/includes/books-ms.conf

cat /data/nginx/includes/books-ms.conf

sudo wget https://raw.githubusercontent.com/vfarcic\
/books-ms/master/nginx-upstreams.ctmpl \
	-O /data/nginx/upstreams/books-ms.ctmpl

cat /data/nginx/upstreams/books-ms.ctmpl

sudo consul-template \
	-consul localhost:8500 \
	-template "/data/nginx/upstreams/books-ms.ctmpl:\
/data/nginx/upstreams/books-ms.conf:\
docker kill -s HUP nginx" \
	-once

cat /data/nginx/upstreams/books-ms.conf

curl http://localhost/api/v1/books \
	| python -mjson.tool

exit
						</code></pre>
					</section>
					<section id="dp-late-intef">
						<h4>Deployment Pipeline: The Late Stages</h4>
						<h2>Run Integration Tests</h2>
						<pre><code data-trim contenteditable>
vagrant ssh cd

curl http://10.100.198.201/api/v1/books \
	| python -mjson.tool

cd ~/books-ms

cat docker-compose-dev.yml

sudo docker-compose \
	-f docker-compose-dev.yml \
	run --rm \
	-e DOMAIN=http://10.100.198.201 \
	integ

sudo docker push 10.100.198.200:5000/books-ms-tests

exit
						</code></pre>
					</section>
					<section id="dp-late-checklist">
						<h4>Deployment Pipeline: The Late Stages</h4>
						<h2>Checklist</h2>
						<ol>
							<img src="img/dp/cd-pipeline-docker-no-ansible.png" style="float: right; width: 50%; height: 50%;">
							<li class="fragment"><del>Checkout the code</del></li>
							<li class="fragment"><del>Run pre-deployment tests</del></li>
							<li class="fragment"><del>Compile and/or package the code</del></li>
							<li class="fragment"><del>Build the container</del></li>
							<li class="fragment"><del>Push the container to the registry</del></li>
							<li class="fragment"><del>Deploy the container to the production server</del></li>
							<li class="fragment"><del>Integrate the container</del></li>
							<li class="fragment"><del>Run post-deployment tests</del></li>
							<li class="fragment"><del>Push the tests container to the registry</del></li>
						</ol>
					</section>
				</section>
				<section>
					<section id="dp-auto" data-transition="fade-in slide-out">
						<h2>Automating the Deployment Pipeline</h2>
						<img src="img/cd-pipeline-docker-no-ansible.png" style="width: 85%; height: 85%;">
					</section>
					<section id="dp-auto-ansible" data-transition="fade-in slide-out">
						<h2>Automating the Deployment Pipeline</h2>
						<img src="img/cd-pipeline-docker-ansible.png" style="width: 85%; height: 85%;">
					</section>
					<section id="dp-auto-nodes" data-transition="fade-in slide-out">
						<h2>Automating the Deployment Pipeline</h2>
						<img src="img/cd-pipeline-docker-nodes.png" style="width: 65%; height: 65%;">
					</section>
					<section id="dp-auto-problems" data-transition="fade-in">
						<h2>Automating the Deployment Pipeline</h2>
						<img src="img/cd-pipeline-docker-problems.png" style="width: 85%; height: 85%;">
					</section>
					<section id="dp-auto-code">
						<h4>Automating the Deployment Pipeline</h4>
						<h2>Checking Out the Code</h2>
						<pre><code data-trim contenteditable>
vagrant ssh cd

cd ~/books-ms

git pull
						</code></pre>
					</section>
					<section id="dp-auto-playbook">
						<h4>Automating the Deployment Pipeline</h4>
						<h2>Ansible Playbook</h2>
						<pre><code data-trim contenteditable>
cat /vagrant/ansible/roles/service/tasks/main.yml
						</code></pre>
					</section>
					<section id="dp-auto-pre-depployment-tests">
						<h4>Automating the Deployment Pipeline</h4>
						<h2>Running the Pre-Deployment Tests, Compiling and Packaging</h2>
						<pre><code data-trim contenteditable>
# roles/service/tasks/main.yml

- name: Tests container is built
  shell: docker build \
    -t 10.100.198.200:5000/{{ service_name }}-tests \
    -f Dockerfile.test .
  args:
    chdir: "{{ repo_dir }}"
  delegate_to: 127.0.0.1
  tags: [service, tests]

- name: Pre-deployment tests are run
  shell: docker-compose \
    -f docker-compose-dev.yml \
    run --rm tests
  args:
    chdir: "{{ repo_dir }}"
  delegate_to: 127.0.0.1
  tags: [service, tests]
						</code></pre>
					</section>
					<section id="dp-auto-build">
						<h4>Automating the Deployment Pipeline</h4>
						<h2>Building the Container</h2>
						<pre><code data-trim contenteditable>
# roles/service/tasks/main.yml

- name: Container is built
  shell: docker build \
    -t 10.100.198.200:5000/{{ service_name }} .
  args:
    chdir: "{{ repo_dir }}"
  delegate_to: 127.0.0.1
  tags: [service]
						</code></pre>
					</section>
					<section id="dp-auto-push">
						<h4>Automating the Deployment Pipeline</h4>
						<h2>Pushing the Container to the Registry</h2>
						<pre><code data-trim contenteditable>
# roles/service/tasks/main.yml

- name: Container is pushed
  shell: docker push \
    10.100.198.200:5000/{{ service_name }}
  delegate_to: 127.0.0.1
  tags: [service]
						</code></pre>
					</section>
					<section id="dp-auto-prepare-deploy">
						<h4>Automating the Deployment Pipeline</h4>
						<h2>Preparing for the Deployment to the Production Server</h2>
						<pre><code data-trim contenteditable>
# roles/service/tasks/main.yml

- name: Directories are created
  file:
    path: /data/{{ service_name }}
    recurse: yes
    state: directory
  tags: [service]

- name: Files are copied
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  with_items: files
  tags: [service]
						</code></pre>
					</section>
					<section id="dp-auto-prepare-deploy-2">
						<h4>Automating the Deployment Pipeline</h4>
						<h2>Preparing for the Deployment to the Production Server</h2>
						<pre><code data-trim contenteditable>
# roles/service/defaults/main.yml

files: [
  {
    src: "{{ repo_dir }}/docker-compose.yml",
    dest: "/data/{{ service_name }}/docker-compose.yml"
  }, {
    src: "{{ repo_dir }}/nginx-includes.conf",
    dest: "/data/nginx/includes/{{ service_name }}.conf"
  }, {
    src: "{{ repo_dir }}/nginx-upstreams.ctmpl",
    dest: "/data/nginx/upstreams/{{ service_name }}.ctmpl"
  }
]
						</code></pre>
					</section>
					<section id="dp-auto-deploy">
						<h4>Automating the Deployment Pipeline</h4>
						<h2>Deploying the Containers to the Production Server</h2>
						<pre><code data-trim contenteditable>
# roles/service/tasks/main.yml

- name: Containers are pulled
  shell: docker-compose pull app
  args:
    chdir: /data/{{ service_name }}
  tags: [service]

- name: Containers are running
  shell: docker-compose up -d app
  args:
    chdir: /data/{{ service_name }}
  tags: [service]
						</code></pre>
					</section>
					<section id="dp-auto-integrate">
						<h4>Automating the Deployment Pipeline</h4>
						<h2>Integrating the Container</h2>
						<pre><code data-trim contenteditable>
# roles/service/tasks/main.yml

- name: Proxy is configured
  shell: consul-template \
    -consul localhost:8500 \
    -template "{{ ct_src }}:{{ ct_dest }}:{{ ct_cmd }}" \
    -once
  tags: [service]
						</code></pre>
					</section>
					<section id="dp-auto-integrate-variables">
						<h4>Automating the Deployment Pipeline</h4>
						<h2>Integration Variables</h2>
						<pre><code data-trim contenteditable>
# roles/service/defaults/main.yml

ct_src: /data/nginx/upstreams/{{ service_name }}.ctmpl
ct_dest: /data/nginx/upstreams/{{ service_name }}.conf
ct_cmd: docker kill -s HUP nginx
						</code></pre>
					</section>
					<section id="dp-auto-post-deployment-tests">
						<h4>Automating the Deployment Pipeline</h4>
						<h2>Running the Post-Deployment Tests</h2>
						<pre><code data-trim contenteditable>
# roles/service/tasks/main.yml

- name: Post-deployment tests are run
  shell: docker-compose \
    -f docker-compose-dev.yml \
    run --rm \
    -e DOMAIN={{ proxy_url }} \
    integ
  args:
    chdir: "{{ repo_dir }}"
  delegate_to: 127.0.0.1
  tags: [service, tests]
						</code></pre>
					</section>
					<section id="dp-auto-push-tests">
						<h4>Automating the Deployment Pipeline</h4>
						<h2>Pushing the Tests Container to the Registry</h2>
						<pre><code data-trim contenteditable>
# roles/service/tasks/main.yml

- name: Tests container is pushed
  shell: docker push \
    10.100.198.200:5000/{{ service_name }}-tests
  delegate_to: 127.0.0.1
  tags: [service, tests]
						</code></pre>
					</section>
					<section id="dp-auto-run-pipeline">
						<h4>Automating the Deployment Pipeline</h4>
						<h2>Running the Deployment Pipeline</h2>
						<pre><code data-trim contenteditable>
cd ~/books-ms

ansible-playbook /vagrant/ansible/service.yml \
	-i /vagrant/ansible/hosts/prod \
	--extra-vars "repo_dir=$PWD service_name=books-ms" \
	-vvvv
						</code></pre>
					</section>
					<section id="dp-auto-clean-up">
						<h4>Automating the Deployment Pipeline</h4>
						<h2>Clean Up</h2>
						<pre><code data-trim contenteditable>
exit

vagrant destroy prod -f
						</code></pre>
					</section>
				</section>
				<section>
					<section id="bg" data-transition="fade-in slide-out">
						<h2>Blue-Green Deployment</h2>
						<h4>&nbsp;</h4>
						<img src="img/bg/blue-green-containers-only.png">
					</section>
					<section id="bg-blue" data-transition="fade-in slide-out">
						<h4>Blue-Green Deployment</h4>
						<h2>Deploy Blue</h2>
						<img src="img/bg/blue-green-containers-deploy-blue.png">
					</section>
					<section id="bg-integ-blue" data-transition="fade-in slide-out">
						<h4>Blue-Green Deployment</h4>
						<h2>Integrate Blue</h2>
						<img src="img/bg/blue-green-containers-integrate-blue.png">
					</section>
					<section id="bg-green" data-transition="fade-in slide-out">
						<h4>Blue-Green Deployment</h4>
						<h2>Deploy Green</h2>
						<img src="img/bg/blue-green-containers-deploy-green.png">
					</section>
					<section id="bg-integ-green" data-transition="fade-in slide-out">
						<h4>Blue-Green Deployment</h4>
						<h2>Integrate Green</h2>
						<img src="img/bg/blue-green-containers-integrate-green.png">
					</section>
					<section id="bg-remove-blue" data-transition="fade-in slide-out">
						<h4>Blue-Green Deployment</h4>
						<h2>Remove Blue</h2>
						<img src="img/bg/blue-green-containers-remove-blue.png">
					</section>
					<section id="bg-get-color" data-transition="fade-in slide-out">
						<h4>Blue-Green Deployment</h4>
						<h2>Get the Current Color</h2>
						<img src="img/bg/blue-green-containers-get-color.png">
					</section>
					<section id="bg-put-color" data-transition="fade-in">
						<h4>Blue-Green Deployment</h4>
						<h2>Put the Current Color</h2>
						<img src="img/bg/blue-green-containers-put-color.png">
					</section>
					<section id="bg-combination">
						<h4>Blue-Green Deployment Playbook</h4>
						<h2>Combinations</h2>
						<ul>
							<li class="fragment">The First Run</li>
							<li class="fragment">After the First Run</li>
							<li class="fragment">Pre-deployment tests failed</li>
							<li class="fragment">Pre-integration tests failed</li>
							<li class="fragment">Post-integration tests failed</li>
						</ul>
					</section>
					<section id="bg-playbook">
						<h4>Blue-Green Deployment Playbook</h4>
						<h2>Playbook</h2>
                    	<pre><code data-trim contenteditable>
cat /vagrant/ansible/service-bg.yml

cat /vagrant/ansible/roles/service-bg/tasks/main.yml

cat /vagrant/ansible/roles/service-bg/tasks/pre-deployment.yml

cat /vagrant/ansible/roles/service-bg/tasks/deployment.yml

cat /vagrant/ansible/roles/service-bg/tasks/post-deployment.yml

cat /vagrant/ansible/roles/service-bg/tasks/rollback.yml

cat /vagrant/ansible/roles/service-bg/tasks/main.yml

cat /vagrant/ansible/roles/service-bg/tasks/copy.yml

cat /vagrant/ansible/roles/service-bg/defaults/main.yml

cat /vagrant/ansible/roles/service-bg/files/get-color.yml

cat /vagrant/ansible/roles/service-bg/files/get-port.yml
						</code></pre>
					</section>
					<section id="bg-run">
						<h4>Blue-Green Deployment Playbook</h4>
						<h2>Running the Playbook</h2>
							<pre><code data-trim contenteditable>
ansible-playbook /vagrant/ansible/service-bg.yml \
	-i /vagrant/ansible/hosts/prod \
	--extra-vars "repo_dir=$PWD service_name=books-ms" \
	-vv

curl 10.100.198.201:8500/v1/catalog/services \
	| jq '.'

curl 10.100.198.201:8500/v1/catalog/service/books-ms-blue \
	| jq '.'

curl http://10.100.198.201:8500/v1/kv/books-ms/color?raw

curl 10.100.198.201/api/v1/books | jq '.'

exit

halt prod
						</code></pre>
					</section>
				</section>
				<section>
					<section id="scale">
						<h2>Clustering And Scaling Services</h2>
						<img src="img/scale/servers.png" class="fragment">
						<img src="img/scale/cluster.png" class="fragment">
					</section>
					<section id="scale-tools">
						<h4>Clustering And Scaling Services</h4>
						<h2>Tools</h2>
						<ul>
							<li class="fragment">Kubernetes</li>
							<li class="fragment">Mesos DCOS</li>
							<li class="fragment"><label class="fragment grow highlight-current-green">Swarm</label></li>
						</ul>
					</section>
					<section id="scale-discovery" data-transition="slide-out">
						<h4>Clustering And Scaling Services</h4>
						<h2>Service Discovery</h2>
						<img src="img/scale/swarm-consul.png">
					</section>
					<section id="scale-master-nodes" data-transition="fade-in slide-out">
						<h4>Clustering And Scaling Services</h4>
						<h2>Master and Nodes</h2>
						<img src="img/scale/swarm-master-nodes.png">
					</section>
					<section id="scale-first-container" data-transition="fade-in slide-out">
						<h4>Clustering And Scaling Services</h4>
						<h2>Deploying the First Container</h2>
						<img src="img/scale/swarm-first-container.png">
					</section>
					<section id="scale-second-container" data-transition="fade-in slide-out">
						<h4>Clustering And Scaling Services</h4>
						<h2>The Second Container</h2>
						<img src="img/scale/swarm-second-container.png">
					</section>
					<section id="scale-nodes-full" data-transition="fade-in slide-out">
						<h4>Clustering And Scaling Services</h4>
						<h2>All Nodes Full</h2>
						<img src="img/scale/swarm-nodes-full.png">
					</section>
					<section id="scale-new-node" data-transition="fade-in slide-out">
						<h4>Clustering And Scaling Services</h4>
						<h2>Adding a New Node</h2>
						<img src="img/scale/swarm-new-node.png">
					</section>
					<section id="scale-failed-node" data-transition="fade-in">
						<h4>Clustering And Scaling Services</h4>
						<h2>Failed Node</h2>
						<img src="img/scale/swarm-failed-node.png">
					</section>
					<section id="scale-swarm-set-up">
						<h4>Clustering And Scaling Services</h4>
						<h2>Setting Up Docker Swarm</h2>
							<pre><code data-trim contenteditable>
vagrant up swarm-master swarm-node-1 swarm-node-2

vagrant ssh cd

ansible-playbook /vagrant/ansible/swarm.yml \
	-i /vagrant/ansible/hosts/prod \
	-vv

cat /vagrant/ansible/swarm.yml

cat /vagrant/ansible/roles/swarm/tasks/main.yml

export DOCKER_HOST=tcp://10.100.195.200:2375

docker info

docker ps -a
							</code></pre>
					</section>
					<section id="scale-swarm-deploy">
						<h4>Clustering And Scaling Services</h4>
						<h2>Deploying with Docker Swarm</h2>
						<pre><code data-trim contenteditable>
cd ~/books-ms

docker-compose up -d app

docker ps -a | grep books

curl 10.100.195.200:8500/v1/catalog/services \
	| jq '.'

curl 10.100.195.200:8500/v1/catalog/service/books-ms \
	| jq '.'

docker ps | grep booksms
						</code></pre>
					</section>
					<section id="scale-testing">
						<h4>Clustering and Scaling Services</h4>
						<h2>Testing Deployments with Docker Swarm</h2>
						<pre><code data-trim contenteditable>
BOOKS_MS_ADDRESS=`curl \
	10.100.195.200:8500/v1/catalog/service/books-ms \
	| jq '.[0].Address'`

BOOKS_MS_PORT=`curl \
	10.100.195.200:8500/v1/catalog/service/books-ms \
	| jq '.[0].ServicePort'`

BOOKS_MS_HOST=${BOOKS_MS_ADDRESS//\"}:${BOOKS_MS_PORT}

echo $BOOKS_MS_HOST

curl -H 'Content-Type: application/json' -X PUT -d \
	'{"_id": 1,
	"title": "My First Book",
	"author": "John Doe",
	"description": "Not a very good book"}' \
	$BOOKS_MS_HOST/api/v1/books | jq '.'

curl $BOOKS_MS_HOST/api/v1/books

docker rm -f swarm-node-1/booksms_app_1

docker rm -f swarm-node-1/booksms_db_1
						</code></pre>
					</section>
					<section id="scale-swarm-deploy-cluster">
						<h4>Clustering And Scaling Services</h4>
						<h2>Deploying with Docker Swarm to the Cluster</h2>
							<pre><code data-trim contenteditable>
docker-compose -f docker-compose-swarm.yml up -d db

curl 10.100.195.200:8500/v1/catalog/services \
	| jq '.'

curl 10.100.195.200:8500/v1/catalog/service/books-ms-db \
	| jq '.'

consul-template \
	-consul 10.100.195.200:8500 \
	-template "docker-compose-swarm.ctmpl:docker-compose-swarm.yml" \
	-once

cat docker-compose-swarm.yml

docker-compose -f docker-compose-swarm.yml run --rm \
	app env | grep 'DB_PORT_27017_TCP_ADDR\|DB_PORT_27017_PORT'

docker-compose -f docker-compose-swarm.yml up -d app
							</code></pre>
					</section>
					<section id="scale-testing-cluster">
						<h4>Clustering And Scaling Services</h4>
						<h2>Testing Deployment with Docker Swarm to the Cluster</h2>
						<pre><code data-trim contenteditable>
curl 10.100.195.200:8500/v1/catalog/services \
	| jq '.'

curl 10.100.195.200:8500/v1/catalog/service/books-ms \
	| jq '.'

docker ps | grep booksms

BOOKS_MS_ADDRESS=`curl \
	10.100.195.200:8500/v1/catalog/service/books-ms \
	| jq '.[0].Address'`

BOOKS_MS_PORT=`curl \
	10.100.195.200:8500/v1/catalog/service/books-ms \
	| jq '.[0].ServicePort'`

BOOKS_MS_HOST=${BOOKS_MS_ADDRESS//\"}:${BOOKS_MS_PORT}

echo $BOOKS_MS_HOST

curl -H 'Content-Type: application/json' -X PUT -d \
	'{"_id": 2,
	"title": "My Second Book",
	"author": "John Doe",
	"description": "A bit better book"}' \
	$BOOKS_MS_HOST/api/v1/books | jq '.'

curl $BOOKS_MS_HOST/api/v1/books | jq '.'
						</code></pre>
					</section>
					<section id="scale-swarm-scale">
						<h4>Clustering And Scaling Services</h4>
						<h2>Scaling Services with Docker Swarm</h2>
						<pre><code data-trim contenteditable>
docker-compose -f docker-compose-swarm.yml scale app=2

docker ps | grep booksms

BOOKS_MS_ADDRESS=`curl \
	10.100.195.200:8500/v1/catalog/service/books-ms \
	| jq '.[0].Address'`

BOOKS_MS_PORT=`curl \
	10.100.195.200:8500/v1/catalog/service/books-ms \
	| jq '.[0].ServicePort'`

BOOKS_MS_HOST=${BOOKS_MS_ADDRESS//\"}:${BOOKS_MS_PORT}

echo $BOOKS_MS_HOST

curl $BOOKS_MS_HOST/api/v1/books | jq '.'

BOOKS_MS_ADDRESS=`curl \
	10.100.195.200:8500/v1/catalog/service/books-ms \
	| jq '.[1].Address'`

BOOKS_MS_PORT=`curl \
	10.100.195.200:8500/v1/catalog/service/books-ms \
	| jq '.[1].ServicePort'`

BOOKS_MS_HOST=${BOOKS_MS_ADDRESS//\"}:${BOOKS_MS_PORT}

echo $BOOKS_MS_HOST

curl $BOOKS_MS_HOST/api/v1/books | jq '.'
						</code></pre>
					</section>
					<section id="scale-swarm-de-scale">
						<h4>Clustering And Scaling Services</h4>
						<h2>Descaling Services with Docker Swarm</h2>
						<pre><code data-trim contenteditable>
docker-compose -f docker-compose-swarm.yml scale app=1

docker ps | grep booksms

BOOKS_MS_ADDRESS=`curl \
	10.100.195.200:8500/v1/catalog/service/books-ms \
	| jq '.[0].Address'`

BOOKS_MS_PORT=`curl \
	10.100.195.200:8500/v1/catalog/service/books-ms \
	| jq '.[0].ServicePort'`

BOOKS_MS_HOST=${BOOKS_MS_ADDRESS//\"}:${BOOKS_MS_PORT}

echo $BOOKS_MS_HOST

curl $BOOKS_MS_HOST/api/v1/books | jq '.'
						</code></pre>
					</section>
					<section id="scale-clean-up">
						<h4>Clustering And Scaling Services</h4>
						<h2>Cleaning Up</h2>
						<pre><code data-trim contenteditable>
docker-compose -f docker-compose-swarm.yml stop app

docker-compose -f docker-compose-swarm.yml rm -f app

docker-compose -f docker-compose-swarm.yml stop db

docker-compose -f docker-compose-swarm.yml rm -f db
						</code></pre>
					</section>
					<section id="scale-swarm-playbook">
						<h4>Clustering And Scaling Services</h4>
						<h2>Examining the Swarm Deployment Playbook</h2>
						<pre><code data-trim contenteditable>
cd ~/books-ms

cat /vagrant/ansible/service-swarm.yml

cat /vagrant/ansible/roles/service-swarm/tasks/main.yml

cat /vagrant/ansible/roles/service-swarm/tasks/pre-deployment.yml

cat /vagrant/ansible/roles/service-swarm/tasks/deployment.yml

cat /vagrant/ansible/roles/service-swarm/tasks/post-deployment.yml

cat /vagrant/ansible/roles/service-swarm/tasks/rollback.yml

cat /vagrant/ansible/roles/service-swarm/tasks/main.yml

cat /vagrant/ansible/roles/service-swarm/tasks/copy.yml

cat /vagrant/ansible/roles/service-swarm/defaults/main.yml

cat /vagrant/ansible/roles/service-swarm/files/get-color.yml

cat /vagrant/ansible/roles/service-swarm/files/get-domain.yml
						</code></pre>
					</section>
					<section id="scale-swarm-playbook-run">
						<h4>Clustering And Scaling Services</h4>
						<h2>Running the Swarm Deployment Playbook</h2>
						<pre><code data-trim contenteditable>
ansible-playbook /vagrant/ansible/service-swarm.yml \
	-i /vagrant/ansible/hosts/prod \
	--extra-vars "repo_dir=$PWD service_name=books-ms" \
	-vv

curl 10.100.195.200:8500/v1/catalog/services \
	| jq '.'

curl 10.100.195.200:8500/v1/catalog/service/books-ms-blue \
	| jq '.'

curl 10.100.195.200:8500/v1/kv/books-ms/color?raw

curl 10.100.195.200/api/v1/books | jq '.'
						</code></pre>
					</section>
					<section id="scale-swarm-scale-ansible">
						<h4>Clustering And Scaling Services</h4>
						<h2>Scaling the Service With Ansible</h2>
						<pre><code data-trim contenteditable>
ansible-playbook /vagrant/ansible/service-swarm.yml \
	-i /vagrant/ansible/hosts/prod \
	--extra-vars "repo_dir=$PWD service_name=books-ms" \
	--skip-tags "pull" --extra-vars "scale_service=2" -vv

curl 10.100.195.200:8500/v1/catalog/services \
	| jq '.'

curl 10.100.195.200:8500/v1/catalog/service/books-ms-green \
	| jq '.'

curl http://10.100.195.200:8500/v1/kv/books-ms/color?raw

curl 10.100.195.200/api/v1/books | jq '.'
						</code></pre>
					</section>
				</section>
				<section id="summary">
					<h2>Summary</h2>
					<h3>Not a silver bullet</h3>
				</section>
				<section id="qa" data-background="img/questions.jpg">
				</section>
				<section>
					<section id="the-end" data-background="img/the_end.jpg">
						<h1>Viktor Farcic</h1>
						<h3><a href="https://twitter.com/vfarcic">@vfarcic</a></h3>
						<h4><a href="http://technologyconversations.com">technology conversations.com</a></h4>
					</section>
				</section>
			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
//					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
