<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Microservices Lifecycle</title>

		<meta name="author" content="Viktor Farcic">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="../css/reveal.css">
		<link rel="stylesheet" href="../css/theme/viktor.css" id="theme">

		<!-- Code syntax highlighting -->
		<!--<link rel="stylesheet" href="../lib/css/zenburn.css">-->

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? '../css/print/pdf.css' : '../css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="../lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section id="cover" data-background="../img/background/microservices.png">
					<h1>Microservices Lifecycle Workshop</h1>
					<hr/>
					<h2>
						<a href="http://technologyconversations.com/about/">Viktor Farcic</a>
					</h2>
					<hr/>
					<h4>
						<a href="https://twitter.com/vfarcic">@vfarcic</a>
					</h4>
					<h4>
						<a href="http://technologyconversations.com">TechnologyConversations.com</a>
					</h4>
					<h4>
						<a href="https://www.cloudbees.com">CloudBees.com</a>
					</h4>
				</section>
				<section data-background="../img/background/about-me.jpg">
					<section id="about-me">
						<h2>Viktor Farcic</h2>
						<img src="../img/viktor.jpg" style="width: 50%; height: 50%;" />
					</section>
					<section id="about-company">
						<a href="https://www.cloudbees.com">
							<img src="../img/cloudbees-big.png" style="background-color: white;" />
						</a>
					</section>
					<section id="about-docker">
						<a href="https://www.docker.com/community/docker-captains">
							<img src="../img/docker-captain.png" style="width: 50%; height: 50%;" />
						</a>
					</section>
					<section id="about-books">
						<a href="https://leanpub.com/the-devops-2-toolkit">
							<img src="../img/devops2.png" style="float: left; width: 40%; height: 40%;" />
						</a>
						<a href="http://www.amazon.com/Test-Driven-Java-Development-Viktor-Farcic-ebook/dp/B00YSIM3SC">
							<img src="../img/tdd.jpg" style="float: right; width: 40%; height: 40%;" />
						</a>
					</section>
				</section>
				<section data-background="../img/background/train.png">
					<section id="ci-cd">
						<h2>Continuous deployment</h2>
						<ul>
							<li class="fragment"><strong>Continuous integration</strong>
								<div>
									<label class="fragment">Push/clone,</label>
									<label class="fragment">Static analysis,</label>
									<label class="fragment">Pre-deployment testing,</label>
									<label class="fragment">Packaging/deployment,</label>
									<label class="fragment">Post-deployment testing</label>
								</div>
							</li>
							<li class="fragment"><strong>Continuous delivery</strong>
								<div>
									<label class="fragment">every commit <label class="fragment grow highlight-current-green">can be</label> deployed to production</label>
								</div>
							</li>
							<li class="fragment"><strong>Continuous deployment</strong>
								<div>
									<label class="fragment">every commit <label class="fragment grow highlight-current-green">is</label> deployed to production</label>
								</div>
							</li>
						</ul>
					</section>
					<section id="ci-process">
						<h4>Continuous deployment</h4>
						<h2>CI process</h2>
						<img src="img/ci-cd/ci.png" style="width: 65%; height: 65%;">
					</section>
					<section id="ci-pipeline">
						<h4>Continuous deployment</h4>
						<h2>CI pipeline</h2>
						<img src="img/ci-cd/ci-pipeline.png">
					</section>
					<section id="cd-process">
						<h4>Continuous deployment</h4>
						<h2>Continuous delivery process</h2>
						<img src="img/ci-cd/cd.png" style="width: 65%; height: 65%;">
					</section>
					<section id="cd-pipeline">
						<img src="img/ci-cd/cd-pipeline.png" style="width: 60%; height: 60%; float: right;">
						<h4>Continuous deployment</h4>
						<h2>Continuous deployment pipeline</h2>
					</section>
				</section>
				<section data-background="img/background/containers.png">
					<section id="containers">
						<h2>Containers (Docker)</h2>
						<blockquote>Shipping container is an object for holding or transporting something</blockquote>
						<img src="img/containers/docker.png" style="float: right; width: 40%; height: 40%; background-color: white;">
						<ul>
							<li class="fragment">Isolated</li>
							<li class="fragment">Immutable</li>
							<li class="fragment">Reliable</li>
							<li class="fragment">Self-sufficient</li>
							<li class="fragment">Scalable</li>
						</ul>
					</section>
					<section id="containers-vms">
						<h4>Containers (Docker)</h4>
						<h2>VMs vs Containers</h2>
						<img src="img/containers/containers-vms.png" style="width: 85%; height: 85%;">
					</section>
					<section id="container-self-sufficient">
						<h4>Containers (Docker)</h4>
						<h2>Self-sufficient container</h2>
						<img src="img/containers/container.png" style="width: 60%; height: 60%;">
					</section>
					<section id="container-db">
						<h4>Containers (Docker)</h4>
						<h2>Container with the separate DB</h2>
						<img src="img/containers/container-db.png" style="width: 90%; height: 90%; ">
					</section>
					<section id="container-shared-db">
						<h4>Containers (Docker)</h4>
						<h2>Containers with the shared DB</h2>
						<img src="img/containers/container-shared-db.png" style="width: 70%; height: 70%; ">
					</section>
				</section>
				<section data-background="img/background/monolith.png">
					<section id="monolith">
						<h2>Monolithic applications</h2>
						<ul>
							<li class="fragment">Single unit</li>
							<li class="fragment">Time increases complexity and size</li>
							<li class="fragment">Time decreases development, testing and deployment speed</li>
							<li class="fragment">Layers</li>
							<li class="fragment">Change is hard and with risks</li>
							<li class="fragment">Scaling = multiplication of the entire application</li>
						</ul>
					</section>
					<section id="monolith-simple">
						<h4>Monolithic applications</h4>
						<h2>Early</h2>
						<img src="img/monolith/monolith.png">
					</section>
					<section id="monolith-features">
						<h4>Monolithic applications</h4>
						<h2>Later</h2>
						<img src="img/monolith/monolith-features.png">
					</section>
					<section id="monolith-scaling">
						<h4>Monolithic applications</h4>
						<h2>Scaling</h2>
						<img src="img/monolith/monolith-scaling.png" style="width: 80%; height: 80%;">
					</section>
				</section>
				<section data-background="img/background/microservices.png">
					<section id="ms">
						<h2>Microservices</h2>
						<h4>Applications that fit into a screen</h4>
						<ul>
							<li class="fragment">System composed of small services</li>
							<li class="fragment">Autonomy/independence</li>
							<li class="fragment">Data exchange through APIs</li>
							<li class="fragment">Bounded context</li>
						</ul>
					</section>
					<section id="ms-diagram">
						<h4>Microservices</h4>
						<h2>Self-Sufficiency</h2>
						<img src="img/ms/microservices.png">
					</section>
					<section id="ms-gartner">
						<h4>Microservices</h4>
						<h2>Gartner</h2>
						<blockquote>
							Microservices are simpler, developers get more productive and systems can be scaled quickly and precisely, rather than in large monolithic globs. And I havenâ€™t even mentioned the potential for polyglot coding and data persistence.
							<br/><div style="float: right;">- Gary Olliffe </div>
						</blockquote>
					</section>
					<section id="ms-ood">
						<h4>Microservices</h4>
						<h2>Object-Oriented Design</h2>
						<blockquote>
							The big idea is 'messaging'.
							The key in making great and growable systems is much more to design how its modules communicate rather than what their internal properties and behaviors should be.
							<br/><div style="float: right;">- Alan Kay</div>
						</blockquote>
					</section>
					<section id="ms-srp">
						<h4>Microservices</h4>
						<h2>Single Responsibility Principle</h2>
						<blockquote>
							Gather together those things that change for the same reason, and separate those things that change for different reasons
							<div style="float: right;">- Robert C. Martin</div>
						</blockquote>
					</section>
					<section id="ms-linux">
						<h4>Microservices</h4>
						<h2>Linux = Microservices</h2>
                    	<pre><code data-trim contenteditable>
ps aux | grep jav[a] | awk '{print $2}' | xargs kill
						</code></pre>
					</section>
				</section>
				<section data-background="img/background/microservices.png">
					<section id="ms-keys">
						<h2>Microservices</h2>
						<ul>
							<li class="fragment">One thing or one functionality</li>
							<li class="fragment">Any tools or languages</li>
							<li class="fragment">Truly loosely coupled</li>
							<li class="fragment">Teams independence</li>
							<li class="fragment">Easier testing and CD</li>
							<li class="fragment">Decentralization</li>
						</ul>
					</section>
					<section id="ms-cons" data-background="img/background/microservices.png">
						<h4>Microservices</h4>
						<h2>Disadvantages</h2>
						<ul>
							<li class="fragment">Increased operational and deployment complexity
								<ul>
									<li class="fragment">Configuration Management</li>
									<li class="fragment">Containers (Docker)</li>
									<li class="fragment">Work shifted from development to DevOps</li>
								</ul>
							</li>
							<li class="fragment">Remote process calls</li>
						</ul>
					</section>
					<section id="ms-pros">
						<h4>Microservices</h4>
						<h2>Advantages</h2>
						<ul>
							<li class="fragment">Scaling</li>
							<li class="fragment">Resilience / fault isolation</li>
							<li class="fragment">Innovation</li>
							<li class="fragment">Size</li>
							<li class="fragment">Decoupling</li>
							<li class="fragment">Deployment</li>
							<li class="fragment">No need for long term commitment</li>
						</ul>
					</section>
					<section id="ms-bp">
						<h4>Microservices</h4>
						<h2>Best Practices</h2>
						<ul>
							<li class="fragment">Containers (Docker)</li>
							<li class="fragment">Reverse proxy</li>
							<li class="fragment">Minimalist approach</li>
							<li class="fragment">CM is a must</li>
							<li class="fragment">Cross functional teams</li>
							<li class="fragment">API versioning</li>
						</ul>
					</section>
				</section>
				<section data-background="img/background/deployment.png">
					<section id="deployment">
						<h2>Deployment</h2>
						<ul>
							<li class="fragment">Big vs small</li>
							<li class="fragment">Mutable vs immutable</li>
						</ul>
					</section>
					<section id="deployment-mutable">
						<h3>Deployment</h3>
						<h2>Mutable Monster Server</h2>
						<div>
							<img src="img/deployment/mutable-application-server.png">
						</div>
					</section>
					<section id="deployment-immutable-server-01" data-transition="fade-in slide-out">
						<h3>Deployment</h3>
						<h2>Immutable Server</h2>
						<div>
							<img src="img/deployment/immutable-application-server-01.png">
						</div>
					</section>
					<section id="deployment-immutable-server-02" data-transition="fade-in slide-out">
						<h3>Deployment</h3>
						<h2>Immutable Server</h2>
						<div>
							<img src="img/deployment/immutable-application-server-02.png">
						</div>
					</section>
					<section id="deployment-immutable-server-03" data-transition="fade-in slide-out">
						<h3>Deployment</h3>
						<h2>Immutable Server</h2>
						<div>
							<img src="img/deployment/immutable-application-server-03.png">
						</div>
					</section>
					<section id="deployment-immutable-server-04" data-transition="fade-in slide-out">
						<h3>Deployment</h3>
						<h2>Immutable Server</h2>
						<div>
							<img src="img/deployment/immutable-application-server-04.png">
						</div>
					</section>
					<section id="deployment-immutable-ms-01" data-transition="fade-in slide-out">
						<h3>Deployment</h3>
						<h2>Immutable Micro Services</h2>
						<div>
							<img src="img/deployment/immutable-microservices-01.png">
						</div>
					</section>
					<section id="deployment-immutable-ms-02" data-transition="fade-in slide-out">
						<h3>Deployment</h3>
						<h2>Immutable Micro Services</h2>
						<div>
							<img src="img/deployment/immutable-microservices-02.png">
						</div>
					</section>
					<section id="deployment-immutable-ms-03" data-transition="fade-in slide-out">
						<h3>Deployment</h3>
						<h2>Immutable Micro Services</h2>
						<div>
							<img src="img/deployment/immutable-microservices-03.png">
						</div>
					</section>
					<section id="deployment-immutable-ms-04" data-transition="fade-in slide-out">
						<h3>Deployment</h3>
						<h2>Immutable Micro Services</h2>
						<div>
							<img src="img/deployment/immutable-microservices-04.png">
						</div>
					</section>
				</section>
				<section data-background="img/background/deployment-pipeline.png">
					<section id="dp">
						<h2>Deployment Pipeline</h2>
						<ol>
							<img src="img/dp/cd-pipeline-docker-no-ansible.png" style="float: right; width: 50%; height: 50%;">
							<li class="fragment">Checkout the code</li>
							<li class="fragment">Run pre-deployment tests</li>
							<li class="fragment">Compile and/or package the code</li>
							<li class="fragment">Build the container</li>
							<li class="fragment">Push the container to the registry</li>
							<li class="fragment">Deploy the container to the production server</li>
							<li class="fragment">Integrate the container</li>
							<li class="fragment">Run post-deployment tests</li>
						</ol>
					</section>
					<section id="dp-env">
						<h4>Deployment Pipeline: Initial Stages</h4>
						<h2>Creating the CD VM</h2>
						<pre><code data-trim contenteditable>git clone https://github.com/vfarcic/ms-lifecycle.git

cd ms-lifecycle

vagrant up cd --provision

vagrant ssh cd</code></pre>
					</section>
					<section id="dp-checkout">
						<h4>Deployment Pipeline: Initial Stages</h4>
						<h2>Checking out the code</h2>
						<pre><code data-trim contenteditable>git clone https://github.com/vfarcic/go-demo.git

cd go-demo</code></pre>
					</section>
					<section id="dp-pre-deployment-tests">
						<h4>Deployment Pipeline: Initial Stages</h4>
						<h2>Running pre-deployment tests and compiling and/or packaging the code</h2>
						<pre><code data-trim contenteditable>cat docker-compose-test.yml

docker-compose -f docker-compose-test.yml run --rm unit

docker ps -a

ll -t</code></pre>
					</section>
					<section id="dp-building">
						<h4>Deployment Pipeline: Initial Stages</h4>
						<h2>Building Docker containers</h2>
						<pre><code data-trim contenteditable>cat Dockerfile

docker build -t vfarcic/go-demo .

docker images</code></pre>
					</section>
					<section id="dp-running">
						<h4>Deployment Pipeline: Initial Stages</h4>
						<h2>Running containers</h2>
						<pre><code data-trim contenteditable>docker-compose up -d db app

docker-compose ps

PORT=&lt;PORT&gt; # Put the port from the ps command

docker-compose logs

docker-compose exec app ping -c 1 db

docker-compose exec db ping -c 1 app</code></pre>
					</section>
					<section id="dp-running-ping">
						<h4>Deployment Pipeline: Initial Stages</h4>
						<h2>Running containers</h2>
						<pre><code data-trim contenteditable>curl localhost:$PORT/demo/hello

curl -XPUT localhost:$PORT/demo/person?name=Viktor

curl -XPUT localhost:$PORT/demo/person?name=Sara

curl localhost:$PORT/demo/person

docker-compose down

docker ps -a</code></pre>
					</section>
					<section id="dp-registry">
						<h4>Deployment Pipeline: Initial Stages</h4>
						<h2>Pushing containers to the registry</h2>
						<pre><code data-trim contenteditable># docker push vfarcic/go-demo

docker tag vfarcic/go-demo 10.100.198.200:5000/go-demo

docker push 10.100.198.200:5000/go-demo

exit</code></pre>
					</section>
					<section id="dp-checklist">
						<h4>Deployment Pipeline: Initial Stages</h4>
						<h2>Checklist</h2>
						<ol>
							<img src="img/dp/cd-pipeline-docker-initial.png" style="float: right; width: 50%; height: 50%;">
							<li class="fragment"><del>Checkout the code</del></li>
							<li class="fragment"><del>Run pre-deployment tests</del></li>
							<li class="fragment"><del>Compile and/or package the code</del></li>
							<li class="fragment"><del>Build the container</del></li>
							<li class="fragment"><del>Push the container to the registry</del></li>
							<li class="fragment">Deploy the container to the production server</li>
							<li class="fragment">Integrate the container</li>
							<li class="fragment">Run post-deployment tests</li>
						</ol>
					</section>
				</section>
				<section data-background="img/background/cm.png">
					<section id="cm">
						<h2>Configuration Management</h2>
						<table>
							<div>
								<img class="fragment" src="../img/products/cfengine.png" style="background-color: white; width: 20%; height: 20%;">
								<img class="fragment" src="../img/products/puppet.png" style="background-color: white; width: 20%; height: 20%;">
								<img class="fragment" src="../img/products/chef.png" style="background-color: white; width: 20%; height: 20%;">
								<img class="fragment" src="../img/products/ansible.png" style="background-color: white; width: 20%; height: 20%;">
							</div>
							<div>
								<img class="fragment" src="../img/products/packer.png" style="width: 40%; height: 40%;">
								<img class="fragment" src="../img/products/terraform.png" style="width: 20%; height: 20%;">
							</div>
						</table>
					</section>
					<section id="cm-prod">
						<h4>Configuration Management</h4>
						<h2>Configuring the Production Environment</h2>
						<pre><code data-trim contenteditable>vagrant up prod

vagrant ssh cd

cd /vagrant/ansible

ansible-playbook prod.yml -i hosts/prod</code></pre>
					</section>
					<section id="cm-playbook">
						<h4>Configuration Management</h4>
						<h2>Production environment Ansible playbook</h2>
						<pre><code data-trim contenteditable>cat prod.yml

cat roles/docker/tasks/main.yml

cat roles/docker/tasks/debian.yml

cat hosts/prod

exit</code></pre>
					</section>
				</section>
				<section data-background="img/background/deployment-pipeline.png">
					<section id="dp2">
						<h2>Deployment Pipeline: Intermediate Stages</h2>
						<ol>
							<img src="img/dp/cd-pipeline-docker-initial.png" style="float: right; width: 50%; height: 50%;">
							<li class="fragment"><del>Checkout the code</del></li>
							<li class="fragment"><del>Run pre-deployment tests</del></li>
							<li class="fragment"><del>Compile and/or package the code</del></li>
							<li class="fragment"><del>Build the container</del></li>
							<li class="fragment"><del>Push the container to the registry</del></li>
							<li class="fragment">Deploy the container to the production server</li>
							<li class="fragment">Integrate the container</li>
							<li class="fragment">Run post-deployment tests</li>
						</ol>
					</section>
					<section id="dp2-deploy">
						<h4>Deployment Pipeline: Intermediate Stages</h4>
						<h2>Deploying containers to the production server</h2>
						<pre><code data-trim contenteditable>vagrant ssh cd

export DOCKER_HOST=tcp://prod:2375

docker ps -a

cd go-demo

docker-compose up -d db app

docker-compose ps</code></pre>
					</section>
					<section id="dp2-verification">
						<h4>Deployment Pipeline: Intermediate Stages</h4>
						<h2>Post-deployment verification</h2>
						<pre><code data-trim contenteditable>docker inspect godemo_app_1

PORT=$(docker inspect \
	--format='{{(index (index .NetworkSettings.Ports "8080/tcp") 0).HostPort}}' \
	godemo_app_1)

echo $PORT

curl -XPUT prod:$PORT/demo/person?name=Viktor

curl -XPUT prod:$PORT/demo/person?name=Sara

curl prod:$PORT/demo/person</code></pre>
					</section>
					<section id="dp2-exit">
						<h4>Deployment Pipeline: Intermediate Stages</h4>
						<h2>Stopping Production Node</h2>
						<pre><code data-trim contenteditable>exit

vagrant halt prod</code></pre>
					</section>
					<section id="dp2-checklist">
						<h4>Deployment Pipeline: Intermediate Stages</h4>
						<h2>Checklist</h2>
						<ol>
							<img src="img/dp/cd-pipeline-docker-intermediate.png" style="float: right; width: 50%; height: 50%;">
							<li class="fragment"><del>Checkout the code</del></li>
							<li class="fragment"><del>Run pre-deployment tests</del></li>
							<li class="fragment"><del>Compile and/or package the code</del></li>
							<li class="fragment"><del>Build the container</del></li>
							<li class="fragment"><del>Push the container to the registry</del></li>
							<li class="fragment"><del>Deploy the container to the production server</del></li>
							<li class="fragment">Integrate the container</li>
							<li class="fragment">Run post-deployment tests</li>
						</ol>
					</section>
				</section>
				<section data-background="img/background/sd.png">
					<section id="sd">
						<h2>Service Discovery</h2>
						<img src="img/sd/service-discovery.png" class="fragment">
					</section>
					<section id="sd-single-node">
						<h4>Service Discovery</h4>
						<h2>Single node</h2>
						<img src="img/sd/single-node-docker.png">
					</section>
					<section id="sd-multi-node">
						<h4>Service Discovery</h4>
						<h2>Multiple nodes</h2>
						<img src="img/sd/multi-node-docker.png">
					</section>
					<section id="sd-elements">
						<h4>Service Discovery</h4>
						<h2>Service Discovery Elements</h2>
						<ul>
							<li class="fragment">Service registry</li>
							<li class="fragment">Service registration</li>
							<li class="fragment">Service discovery</li>
						</ul>
					</section>
					<section id="sd-tools">
						<h4>Service Discovery</h4>
						<h2>Tools</h2>
						<div>
							<img class="fragment" src="../img/products/zookeeper.png" class="fragment" style="width: 40%; height: 40%; background-color: white;"/>
						</div>
						<div>
							<img class="fragment" src="../img/products/etcd.png" class="fragment" style="width: 40%; height: 40%; background-color: white;"/>
							<img class="fragment" src="../img/products/consul.jpg" class="fragment" style="width: 40%; height: 40%;"/>
						</div>
					</section>
					<section id="sd-consul-playbook">
						<h4>Service Discovery</h4>
						<h2>Consul Ansible playbook</h2>
						<pre><code data-trim contenteditable>vagrant up serv-disc-01 serv-disc-02 serv-disc-03

vagrant ssh cd

cat /vagrant/ansible/hosts/serv-disc

cat /vagrant/ansible/consul.yml

cat /vagrant/ansible/roles/consul/tasks/main.yml

cat /vagrant/ansible/roles/consul/defaults/main.yml

cat /vagrant/ansible/host_vars/10.100.194.201</code></pre>
					</section>
					<section id="sd-consul-setup">
						<h4>Service Discovery</h4>
						<h2>Setting up Consul</h2>
						<pre><code data-trim contenteditable>ansible-playbook \
    /vagrant/ansible/consul.yml \
    -i /vagrant/ansible/hosts/serv-disc

curl serv-disc-01:8500/v1/catalog/nodes | jq '.'</code></pre>
					</section>
					<section id="sd-consul-diagram">
						<h4>Service Discovery</h4>
						<h2>Consul</h2>
						<img src="img/sd/consul.png">
					</section>
					<section id="sd-kv-put">
						<h4>Service Discovery</h4>
						<h2>Key/value store: PUT</h2>
						<pre><code data-trim contenteditable>curl -X PUT -d 'this is a test' \
    serv-disc-01:8500/v1/kv/msg1

curl -X PUT -d 'this is another test' \
    serv-disc-02:8500/v1/kv/messages/msg2

curl -X PUT -d 'this is a test with flags' \
    serv-disc-03:8500/v1/kv/messages/msg3?flags=1234</code></pre>
					</section>
					<section id="sd-kv-get-delete">
						<h4>Service Discovery</h4>
						<h2>Key/value store: GET/DELETE</h2>
						<pre><code data-trim contenteditable>curl serv-disc-03:8500/v1/kv/?recurse | jq '.'

curl serv-disc-02:8500/v1/kv/msg1 | jq '.'

curl serv-disc-01:8500/v1/kv/msg1?raw

curl -X DELETE serv-disc-01:8500/v1/kv/messages/msg2

curl serv-disc-03:8500/v1/kv/?recurse | jq '.'

curl -X DELETE serv-disc-02:8500/v1/kv/?recurse

curl serv-disc-03:8500/v1/kv/?recurse | jq '.'</code></pre>
					</section>
					<section id="sd-registrator-playbook">
						<h4>Service Discovery</h4>
						<h2>Registrator</h2>
						<pre><code data-trim contenteditable>cat /vagrant/ansible/roles/registrator/tasks/main.yml

cat /vagrant/ansible/roles/registrator/defaults/main.yml

ansible-playbook \
    /vagrant/ansible/registrator.yml \
    -i /vagrant/ansible/hosts/serv-disc</code></pre>
					</section>
					<section id="sd-consul-registrator-diagram">
						<h4>Service Discovery</h4>
						<h2>Consul / Registrator</h2>
						<img src="img/sd/consul-registrator.png">
					</section>
					<section id="sd-nginx">
						<h4>Service Discovery</h4>
						<h2>Registering service</h2>
						<pre><code data-trim contenteditable>docker -H tcp://serv-disc-01:2375 run -d \
    --name nginx \
    --env SERVICE_NAME=nginx \
    --env SERVICE_ID=nginx \
    -p 1234:80 \
    nginx:alpine

curl serv-disc-01:8500/v1/catalog/service/nginx-80 | jq '.'</code></pre>
					</section>
					<section id="sd-nginx2">
						<h4>Service Discovery</h4>
						<h2>Registering service again</h2>
						<pre><code data-trim contenteditable>docker -H tcp://serv-disc-02:2375 run -d \
    --name nginx2 \
    --env "SERVICE_ID=nginx2" \
    --env "SERVICE_NAME=nginx" \
    --env "SERVICE_TAGS=balancer,proxy,www" \
    -p 1111:80 \
    nginx:alpine

curl serv-disc-02:8500/v1/catalog/service/nginx-80 | jq '.'</code></pre>
					</section>
					<section id="sd-consul-registrator-consul-template-diagram">
						<h4>Service Discovery</h4>
						<h2>Consul / Registrator / Consul Template</h2>
						<img src="img/sd/consul-registrator-consul-template.png">
					</section>
					<section id="sd-consul-template-run">
						<h4>Service Discovery</h4>
						<h2>Running Consul Template</h2>
						<pre><code data-trim contenteditable>curl serv-disc-01:8500/v1/catalog/service/nginx-80 | jq '.'

cat /data/consul-template/example2.ctmpl

consul-template \
    -consul serv-disc-01:8500 \
    -template "/data/consul-template/example2.ctmpl:/tmp/example.conf" \
    -once

cat /tmp/example.conf</code></pre>
					</section>
					<section id="sd-cleanup">
						<h4>Service Discovery</h4>
						<h2>Cleanup</h2>
						<pre><code data-trim contenteditable>exit # Exit cd node

vagrant destroy -f serv-disc-01 serv-disc-02 serv-disc-03</code></pre>
					</section>
				</section>
				<section data-background="img/background/proxy.png">
					<section id="proxy">
						<h2>Proxy Service</h2>
						<img src="img/ms/microservices.png" class="fragment">
					</section>
					<section id="proxy-playbook">
						<h4>Proxy Service</h4>
						<h2>nginx Ansible Playbook</h2>
						<pre><code data-trim contenteditable>vagrant up proxy

vagrant ssh cd

cat /vagrant/ansible/nginx.yml

cat /vagrant/ansible/roles/nginx/files/services.conf

ansible-playbook /vagrant/ansible/nginx.yml \
    -i /vagrant/ansible/hosts/proxy

export DOCKER_HOST=tcp://proxy:2375

docker ps

curl proxy:8500/v1/catalog/services | jq '.'</code></pre>
					</section>
					<section id="proxy-without">
						<h4>Proxy Service</h4>
						<h2>Services Without Proxy</h2>
						<pre><code data-trim contenteditable>cd go-demo

docker-compose up -d db app

curl proxy/api/v1/books

docker-compose ps

PORT=$(docker inspect \
    --format='{{(index (index .NetworkSettings.Ports "8080/tcp") 0).HostPort}}' \
    godemo_app_1)

curl proxy:$PORT/demo/hello

exit</code></pre>
					</section>
					<section id="proxy-without-diagram">
						<h4>Proxy Service</h4>
						<h2>Services Without Proxy</h2>
						<img src="img/proxy/proxy-without.png">
					</section>
					<section id="proxy-manual">
						<h4>Proxy Service</h4>
						<h2>Manually Setting Proxy</h2>
						<pre><code data-trim contenteditable>vagrant ssh proxy

PORT=$(docker inspect \
    --format='{{(index (index .NetworkSettings.Ports "8080/tcp") 0).HostPort}}' \
    godemo_app_1)

echo "location /demo {
    proxy_pass http://10.100.193.200:$PORT/demo;
}" | sudo tee /data/nginx/includes/go-demo.conf

docker kill -s HUP nginx

curl http://localhost/demo/hello

docker rm -f nginx

exit</code></pre>
					</section>
					<section id="proxy-manual-diagram">
						<h4>Proxy Service</h4>
						<h2>Manually Setting Proxy</h2>
						<img src="img/proxy/proxy-manual.png" style="width: 75%; height: 75%;">
					</section>
					<section id="docker-flow-proxy-reconf">
						<h4>Proxy Service</h4>
						<h2>Docker Flow: Proxy</h2>
						<pre><code data-trim contenteditable>vagrant ssh cd

export DOCKER_HOST=tcp://proxy:2375

docker run -d \
    --name docker-flow-proxy \
    -e CONSUL_ADDRESS=10.100.193.200:8500 \
    -p 80:80 -p 8081:8080 \
    vfarcic/docker-flow-proxy

curl "proxy:8081/v1/docker-flow-proxy/reconfigure?serviceName=go-demo&servicePath=/demo" \
    | jq '.'

curl -i proxy/demo/hello</code></pre>
					</section>
					<section id="docker-flow-proxy-scale">
						<h4>Proxy Service</h4>
						<h2>Docker Flow: Proxy</h2>
						<pre><code data-trim contenteditable>cd go-demo

docker-compose ps

docker-compose scale app=3

docker-compose ps

curl "proxy:8081/v1/docker-flow-proxy/reconfigure?serviceName=go-demo&servicePath=/demo" \
    | jq '.'

curl -i proxy/demo/hello # Repeat a few times

docker-compose logs app</code></pre>
					</section>
					<section id="docker-flow-proxy-user-diag">
						<h4>Deployment</h4>
						<h2>Docker Flow: Proxy</h2>
						<img src="../img/docker-flow-proxy/user.png"/>
					</section>
					<section id="proxy-cleanup">
						<h4>Proxy Service</h4>
						<h2>Cleanup</h2>
						<pre><code data-trim contenteditable>exit

vagrant halt proxy</code></pre>
					</section>
				</section>
				<section data-background="img/background/deployment-pipeline.png">
					<section id="dp-late">
						<h2>Deployment Pipeline: The Late Stages</h2>
						<ol>
							<img src="img/dp/cd-pipeline-docker-intermediate.png" style="float: right; width: 50%; height: 50%;">
							<li class="fragment"><del>Checkout the code</del></li>
							<li class="fragment"><del>Run pre-deployment tests</del></li>
							<li class="fragment"><del>Compile and/or package the code</del></li>
							<li class="fragment"><del>Build the container</del></li>
							<li class="fragment"><del>Push the container to the registry</del></li>
							<li class="fragment"><del>Deploy the container to the production server</del></li>
							<li class="fragment">Integrate the container</li>
							<li class="fragment">Run post-deployment tests</li>
						</ol>
					</section>
					<section id="dp-late-provision">
						<h4>Deployment Pipeline: The Late Stages</h4>
						<h2>Provision Production</h2>
						<pre><code data-trim contenteditable>vagrant up prod

vagrant ssh cd

cd /vagrant/ansible

ansible-playbook prod2.yml -i hosts/prod --skip-tags "nginx"</code></pre>
					</section>
					<section id="dp-late-run">
						<h4>Deployment Pipeline: The Late Stages</h4>
						<h2>Run Containers</h2>
						<pre><code data-trim contenteditable>export DOCKER_HOST=tcp://prod:2375

cd ~/go-demo

docker-compose up -d db app

curl prod:8500/v1/catalog/service/go-demo \
    | jq '.'</code></pre>
						Open <a href="http://10.100.198.201:8500/ui">http://10.100.198.201:8500/ui</a>.
					</section>
					<section id="dp-late-proxy">
						<h4>Deployment Pipeline: The Late Stages</h4>
						<h2>Reconfigure the Proxy</h2>
						<pre><code data-trim contenteditable>curl -i prod/demo/hello

docker run -d \
    --name docker-flow-proxy \
    -e CONSUL_ADDRESS=10.100.198.201:8500 \
    -p 80:80 -p 8081:8080 \
    vfarcic/docker-flow-proxy

curl "prod:8081/v1/docker-flow-proxy/reconfigure?serviceName=go-demo&servicePath=/demo" \
    | jq '.'

curl -i prod/demo/hello</code></pre>
					</section>
					<section id="dp-late-intef">
						<h4>Deployment Pipeline: The Late Stages</h4>
						<h2>Run Integration Tests</h2>
						<pre><code data-trim contenteditable>cat docker-compose-test.yml

unset DOCKER_HOST

export HOST_IP=10.100.198.201

docker-compose \
    -f docker-compose-test.yml \
    run --rm production

# docker push vfarcic/go-demo</code></pre>
					</section>
					<section id="dp-later-clean-up">
						<h4>Deployment Pipeline: The Late Stages</h4>
						<h2>Clean Up</h2>
						<pre><code data-trim contenteditable>export DOCKER_HOST=tcp://prod:2375

docker-compose down

curl "prod:8081/v1/docker-flow-proxy/remove?serviceName=go-demo" \
    | jq '.'</code></pre>
					</section>
					<section id="dp-late-checklist">
						<h4>Deployment Pipeline: The Late Stages</h4>
						<h2>Checklist</h2>
						<ol>
							<img src="img/dp/cd-pipeline-docker-no-ansible.png" style="float: right; width: 50%; height: 50%;">
							<li class="fragment"><del>Checkout the code</del></li>
							<li class="fragment"><del>Run pre-deployment tests</del></li>
							<li class="fragment"><del>Compile and/or package the code</del></li>
							<li class="fragment"><del>Build the container</del></li>
							<li class="fragment"><del>Push the container to the registry</del></li>
							<li class="fragment"><del>Deploy the container to the production server</del></li>
							<li class="fragment"><del>Integrate the container</del></li>
							<li class="fragment"><del>Run post-deployment tests</del></li>
						</ol>
					</section>
					<section id="dp-late-problems">
						<h4>Deployment Pipeline: The Late Stages</h4>
						<h2>Problems</h2>
						<ol>
							<li class="fragment">Downtime</li>
							<li class="fragment">Not scalable</li>
							<li class="fragment">Not failure tolerant</li>
							<li class="fragment">Difficult to monitor</li>
							<li class="fragment">Not automated</li>
						</ol>
					</section>
				</section>
				<section data-background="img/background/blue-green.png">
					<section id="deployment-standard" data-transition="fade-in slide-out">
						<h2>Standard Deployment</h2>
					</section>
					<section id="deployment-standard-1" data-transition="fade-in slide-out">
						<h2>Standard Deployment</h2>
						<img src="img/deployment/deployment-standard-1.png" style="width: 60%; height: 60%;">
					</section>
					<section id="deployment-standard-2" data-transition="fade-in slide-out">
						<h2>Standard Deployment</h2>
						<img src="img/deployment/deployment-standard-2.png" style="width: 60%; height: 60%;">
					</section>
					<section id="bg" data-transition="fade-in slide-out">
						<h2>Blue-Green Deployment</h2>
					</section>
					<section id="bg-1" data-transition="fade-in slide-out">
						<h2>Blue-Green Deployment</h2>
						<img src="img/deployment/deployment-bg-1.png" style="width: 60%; height: 60%;">
					</section>
					<section id="bg-2" data-transition="fade-in slide-out">
						<h2>Blue-Green Deployment</h2>
						<img src="img/deployment/deployment-bg-2.png" style="width: 60%; height: 60%;">
					</section>
					<section id="bg-3" data-transition="fade-in slide-out">
						<h2>Blue-Green Deployment</h2>
						<img src="img/deployment/deployment-bg-3.png" style="width: 60%; height: 60%;">
					</section>
					<section id="bg-4" data-transition="fade-in slide-out">
						<h2>Blue-Green Deployment</h2>
						<img src="img/deployment/deployment-bg-4.png" style="width: 60%; height: 60%;">
					</section>
					<section id="bg-code-1">
						<h2>Blue-Green Deployment</h2>
                        <pre><code data-trim contenteditable>cat docker-compose-bg.yml

export NEXT_COLOR=blue

VERSION=:1.0 docker-compose -f docker-compose-bg.yml \
    up -d db app-${NEXT_COLOR}

curl "prod:8081/v1/docker-flow-proxy/reconfigure?serviceName=go-demo-${NEXT_COLOR}&servicePath=/demo" \
    | jq '.'

curl -i prod/demo/hello

docker-compose -f docker-compose-bg.yml logs

curl -XPUT -d $NEXT_COLOR prod:8500/v1/kv/go-demo/color</code></pre>
					</section>
					<section id="bg-diag-1">
						<h2>Blue-Green Deployment</h2>
						<img src="img/docker-flow-proxy/docker-flow-proxy-deployment-bg-single-server-1.png" style="width: 70%; height: 70%;"/>
					</section>
					<section id="bg-code-2">
						<h2>Blue-Green Deployment</h2>
                        <pre><code data-trim contenteditable>COLOR=$(curl prod:8500/v1/kv/go-demo/color?raw)

NEXT_COLOR=$(if [[ "$COLOR" == "blue" ]]; then echo "green"
else echo "blue"; fi)

VERSION=:1.1 docker-compose -f docker-compose-bg.yml \
    up -d db app-${NEXT_COLOR}

docker-compose -f docker-compose-bg.yml ps

curl -i prod/demo/hello

docker-compose -f docker-compose-bg.yml logs</code></pre>
					</section>
					<section id="bg-diag-2">
						<h2>Blue-Green Deployment</h2>
						<img src="img/docker-flow-proxy/docker-flow-proxy-deployment-bg-single-server-2.png" style="width: 70%; height: 70%;"/>
					</section>
					<section id="bg-code-3">
						<h2>Blue-Green Deployment</h2>
                        <pre><code data-trim contenteditable>curl "prod:8081/v1/docker-flow-proxy/reconfigure?serviceName=go-demo-${NEXT_COLOR}&servicePath=/demo" \
    | jq '.'

curl "prod:8081/v1/docker-flow-proxy/remove?serviceName=go-demo-${COLOR}" \
    | jq '.'

curl -XPUT -d $NEXT_COLOR prod:8500/v1/kv/go-demo/color

curl -i prod/demo/hello # Repeat

docker-compose -f docker-compose-bg.yml logs

docker-compose -f docker-compose-bg.yml stop app-${COLOR}

docker-compose -f docker-compose-bg.yml ps</code></pre>
					</section>
					<section id="bg-diag-3">
						<h2>Blue-Green Deployment</h2>
						<img src="img/docker-flow-proxy/docker-flow-proxy-deployment-bg-single-server-3.png" style="width: 70%; height: 70%;"/>
					</section>
					<section id="bg-code-4">
						<h2>Blue-Green Deployment</h2>
                        <pre><code data-trim contenteditable>docker-compose -f docker-compose-bg.yml down

curl "prod:8081/v1/docker-flow-proxy/remove?serviceName=go-demo-${NEXT_COLOR}" \
    | jq '.'</code></pre>
					</section>
					<section id="df-code-1">
						<h2>Docker Flow</h2>
						<pre><code data-trim contenteditable>export FLOW_PROXY_HOST=10.100.198.201

export FLOW_PROXY_RECONF_PORT=8081

export FLOW_CONSUL_ADDRESS=http://10.100.198.201:8500

export FLOW_PROXY_DOCKER_HOST=tcp://10.100.198.201:2375

docker-flow --flow=deploy --flow=proxy --flow=stop-old

docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

curl -i prod/demo/hello</code></pre>
					</section>
					<section id="df-code-2">
						<h2>Docker Flow</h2>
                            <pre><code data-trim contenteditable>docker-flow --flow=deploy --flow=proxy --flow=stop-old

docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

curl -i prod/demo/hello</code></pre>
					</section>
					<section id="df-code-3">
						<h2>Clean Up</h2>
                            <pre><code data-trim contenteditable>exit

vagrant destroy -f prod</code></pre>
					</section>
				</section>
				<section data-background="../img/background/scaling.png">
					<section id="scale">
						<h2>Clustering And Scaling Services</h2>
						<img src="img/scale/servers.png" class="fragment">
						<img src="img/scale/cluster.png" class="fragment">
					</section>
					<section id="scale-tools">
						<h4>Clustering And Scaling Services</h4>
						<h2>Tools</h2>
						<ul>
							<li class="fragment">Kubernetes</li>
							<li class="fragment">Mesos DCOS</li>
							<li class="fragment"><label class="fragment grow highlight-current-green">Swarm</label></li>
						</ul>
					</section>
					<section id="scale-discovery" data-transition="slide-out">
						<h4>Clustering And Scaling Services</h4>
						<h2>Service Discovery</h2>
						<img src="img/scale/swarm-consul.png">
					</section>
					<section id="scale-master-nodes" data-transition="fade-in slide-out">
						<h4>Clustering And Scaling Services</h4>
						<h2>Master and Nodes</h2>
						<img src="img/scale/swarm-master-nodes.png">
					</section>
					<section id="scale-first-container" data-transition="fade-in slide-out">
						<h4>Clustering And Scaling Services</h4>
						<h2>Deploying the First Container</h2>
						<img src="img/scale/swarm-first-container.png">
					</section>
					<section id="scale-second-container" data-transition="fade-in slide-out">
						<h4>Clustering And Scaling Services</h4>
						<h2>The Second Container</h2>
						<img src="img/scale/swarm-second-container.png">
					</section>
					<section id="scale-nodes-full" data-transition="fade-in slide-out">
						<h4>Clustering And Scaling Services</h4>
						<h2>All Nodes Full</h2>
						<img src="img/scale/swarm-nodes-full.png">
					</section>
					<section id="scale-new-node" data-transition="fade-in slide-out">
						<h4>Clustering And Scaling Services</h4>
						<h2>Adding a New Node</h2>
						<img src="img/scale/swarm-new-node.png">
					</section>
					<section id="scale-failed-node" data-transition="fade-in">
						<h4>Clustering And Scaling Services</h4>
						<h2>Failed Node</h2>
						<img src="img/scale/swarm-failed-node.png">
					</section>
					<section id="scale-swarm-set-up">
						<h4>Clustering And Scaling Services</h4>
						<h2>Setting Up Docker Swarm</h2>
							<pre><code data-trim contenteditable>
vagrant up swarm-master swarm-node-1 swarm-node-2

vagrant ssh cd

cat /vagrant/ansible/swarm.yml

cat /vagrant/ansible/roles/swarm/tasks/main.yml

ansible-playbook /vagrant/ansible/swarm.yml \
    -i /vagrant/ansible/hosts/prod

export DOCKER_HOST=tcp://10.100.192.200:2375

docker info

docker ps -a
							</code></pre>
					</section>
					<section id="scale-swarm-deploy">
						<h4>Clustering And Scaling Services</h4>
						<h2>Deploying with Docker Swarm</h2>
						<pre><code data-trim contenteditable>
cd ~/books-ms

docker-compose up -d app

docker-compose ps

docker ps -a | grep books

curl 10.100.192.200:8500/v1/catalog/services \
    | jq '.'

curl 10.100.192.200:8500/v1/catalog/service/books-ms \
    | jq '.'
						</code></pre>
					</section>
					<section id="scale-testing">
						<h4>Clustering and Scaling Services</h4>
						<h2>Testing Deployments with Docker Swarm</h2>
						<pre><code data-trim contenteditable>
BOOKS_MS_ADDRESS=`curl \
    10.100.192.200:8500/v1/catalog/service/books-ms \
    | jq '.[0].Address'`

BOOKS_MS_PORT=`curl \
    10.100.192.200:8500/v1/catalog/service/books-ms \
    | jq '.[0].ServicePort'`

BOOKS_MS_HOST=${BOOKS_MS_ADDRESS//\"}:${BOOKS_MS_PORT}

echo $BOOKS_MS_HOST

curl -H 'Content-Type: application/json' -X PUT -d \
    '{"_id": 1,
    "title": "My First Book",
    "author": "John Doe",
    "description": "Not a very good book"}' \
    $BOOKS_MS_HOST/api/v1/books | jq '.'

curl $BOOKS_MS_HOST/api/v1/books | jq '.'

docker-compose stop app db

docker-compose rm -f app db

docker ps -a
						</code></pre>
					</section>
					<section id="scale-swarm-deploy-cluster">
						<h4>Clustering and Scaling Services</h4>
						<h2>Deploying with Docker Swarm to the Cluster</h2>
							<pre><code data-trim contenteditable>
cat docker-compose-swarm.yml

docker-compose --x-networking \
    -f docker-compose-swarm.yml \
    up -d db app

curl 10.100.192.200:8500/v1/catalog/services \
    | jq '.'

docker ps --filter name=books --format "table {{.Names}}"

docker exec -t booksms_app_1 cat /etc/hosts
							</code></pre>
					</section>
					<section id="scale-testing-cluster">
						<h4>Clustering And Scaling Services</h4>
						<h2>Testing Deployment with Docker Swarm to the Cluster</h2>
						<pre><code data-trim contenteditable>
BOOKS_MS_ADDRESS=`curl \
    10.100.192.200:8500/v1/catalog/service/books-ms \
    | jq '.[0].Address'`

BOOKS_MS_PORT=`curl \
    10.100.192.200:8500/v1/catalog/service/books-ms \
    | jq '.[0].ServicePort'`

BOOKS_MS_HOST=${BOOKS_MS_ADDRESS//\"}:${BOOKS_MS_PORT}

echo $BOOKS_MS_HOST

curl -H 'Content-Type: application/json' -X PUT -d \
    '{"_id": 2,
    "title": "My Second Book",
    "author": "John Doe",
    "description": "A bit better book"}' \
    $BOOKS_MS_HOST/api/v1/books | jq '.'

curl $BOOKS_MS_HOST/api/v1/books | jq '.'
						</code></pre>
					</section>
					<section id="scale-swarm-scale">
						<h4>Clustering And Scaling Services</h4>
						<h2>Scaling Services with Docker Swarm</h2>
						<pre><code data-trim contenteditable>
docker-compose --x-networking \
    -f docker-compose-swarm.yml \
    scale app=3

docker ps --filter name=books --format "table {{.Names}}"

BOOKS_MS_ADDRESS=`curl \
    10.100.192.200:8500/v1/catalog/service/books-ms \
    | jq '.[0].Address'`

BOOKS_MS_PORT=`curl \
    10.100.192.200:8500/v1/catalog/service/books-ms \
    | jq '.[0].ServicePort'`

BOOKS_MS_HOST=${BOOKS_MS_ADDRESS//\"}:${BOOKS_MS_PORT}

echo $BOOKS_MS_HOST

curl $BOOKS_MS_HOST/api/v1/books | jq '.'

BOOKS_MS_ADDRESS=`curl \
    10.100.192.200:8500/v1/catalog/service/books-ms \
    | jq '.[1].Address'`

BOOKS_MS_PORT=`curl \
    10.100.192.200:8500/v1/catalog/service/books-ms \
    | jq '.[1].ServicePort'`

BOOKS_MS_HOST=${BOOKS_MS_ADDRESS//\"}:${BOOKS_MS_PORT}

echo $BOOKS_MS_HOST

curl $BOOKS_MS_HOST/api/v1/books | jq '.'
						</code></pre>
					</section>
					<section id="scale-swarm-de-scale">
						<h4>Clustering And Scaling Services</h4>
						<h2>Descaling Services with Docker Swarm</h2>
						<pre><code data-trim contenteditable>
docker-compose --x-networking \
    -f docker-compose-swarm.yml \
    scale app=1

docker ps --filter name=books --format "table {{.Names}}"

BOOKS_MS_ADDRESS=`curl \
    10.100.192.200:8500/v1/catalog/service/books-ms \
    | jq '.[0].Address'`

BOOKS_MS_PORT=`curl \
    10.100.192.200:8500/v1/catalog/service/books-ms \
    | jq '.[0].ServicePort'`

BOOKS_MS_HOST=${BOOKS_MS_ADDRESS//\"}:${BOOKS_MS_PORT}

echo $BOOKS_MS_HOST

curl $BOOKS_MS_HOST/api/v1/books | jq '.'
						</code></pre>
					</section>
					<section id="scale-clean-up">
						<h4>Clustering And Scaling Services</h4>
						<h2>Cleaning Up</h2>
						<pre><code data-trim contenteditable>
docker-compose -f docker-compose-swarm.yml stop app db

docker-compose -f docker-compose-swarm.yml rm -f app db

docker ps -a
						</code></pre>
					</section>
					<section id="scale-swarm-playbook">
						<h4>Clustering And Scaling Services</h4>
						<h2>Examining the Swarm Deployment Playbook</h2>
						<pre><code data-trim contenteditable>
cat /vagrant/ansible/service-swarm.yml

cat /vagrant/ansible/roles/service-swarm/tasks/main.yml

cat /vagrant/ansible/roles/service-swarm/tasks/pre-deployment.yml

cat /vagrant/ansible/roles/service-swarm/tasks/deployment.yml

cat /vagrant/ansible/roles/service-swarm/tasks/nginx.yml

cat /vagrant/ansible/roles/service-swarm/tasks/post-deployment.yml

cat /vagrant/ansible/roles/service-swarm/tasks/rollback.yml

cat /vagrant/ansible/roles/service-swarm/tasks/main.yml

cat /vagrant/ansible/roles/service-swarm/tasks/copy.yml

cat /vagrant/ansible/roles/service-swarm/defaults/main.yml

cat /vagrant/ansible/roles/service-swarm/files/get-color.sh

cat /vagrant/ansible/roles/service-swarm/files/get-domain.sh
						</code></pre>
					</section>
					<section id="scale-swarm-playbook-run">
						<h4>Clustering And Scaling Services</h4>
						<h2>Running the Swarm Deployment Playbook</h2>
						<pre><code data-trim contenteditable>
ansible-playbook /vagrant/ansible/service-swarm.yml \
    -i /vagrant/ansible/hosts/prod \
    --extra-vars "repo_dir=$PWD service_name=books-ms" \
    -vv --skip-tags "build,pull,push"

curl 10.100.192.200:8500/v1/catalog/services \
    | jq '.'

curl 10.100.192.200:8500/v1/catalog/service/books-db \
    | jq '.'

curl 10.100.192.200:8500/v1/catalog/service/books-ms-blue \
    | jq '.'

curl 10.100.192.200:8500/v1/kv/books-ms/color?raw

curl 10.100.192.200/api/v1/books | jq '.'
						</code></pre>
					</section>
					<section id="scale-swarm-scale-ansible">
						<h4>Clustering And Scaling Services</h4>
						<h2>Scaling the Service With Ansible</h2>
						<pre><code data-trim contenteditable>
ansible-playbook /vagrant/ansible/service-swarm.yml \
    -i /vagrant/ansible/hosts/prod \
    --extra-vars "repo_dir=$PWD service_name=books-ms" \
    --skip-tags "build,pull,push" --extra-vars "scale_service=3"

curl 10.100.192.200:8500/v1/catalog/services \
    | jq '.'

curl 10.100.192.200:8500/v1/catalog/service/books-ms-green \
    | jq '.'

curl http://10.100.192.200:8500/v1/kv/books-ms/color?raw

curl 10.100.192.200/api/v1/books | jq '.'
						</code></pre>
					</section>
				</section>
				<section data-background="img/background/jenkins.png">
					<section id="jenkins">
						<h2>CI Tools</h2>
						<ul>
							<li class="fragment">GoCD</li>
							<li class="fragment">Bamboo</li>
							<li class="fragment">Travis</li>
							<li class="fragment">CircleCI</li>
							<li class="fragment">Shippable</li>
							<li class="fragment"><label class="fragment grow highlight-current-green">Jenkins</label></li>
						</ul>
					</section>
					<section id="jenkins-setup">
						<h4>CI Tools</h4>
						<h2>Jenkins Setup</h2>
						<pre><code data-trim contenteditable>
ansible-playbook /vagrant/ansible/jenkins.yml \
    -c local

cat /vagrant/ansible/jenkins.yml

cat /vagrant/ansible/roles/java/tasks/main.yml

cat /vagrant/ansible/roles/jenkins/tasks/main.yml

cat /vagrant/ansible/roles/jenkins/defaults/main.yml

cat /vagrant/ansible/roles/jenkins/templates/service-config.xml
						</code></pre>
						Open <a href="http://10.100.198.200:8080">http://10.100.198.200:8080</a>
					</section>
				</section>
				<section data-background="img/background/health.png">
					<section id="health">
						<h2>Self-Healing Systems</h2>
						<ul>
							<li class="fragment">Application level</li>
							<li class="fragment">System level</li>
							<li class="fragment">Hardware level</li>
						</ul>
					</section>
					<section id="health-ttl">
						<h4>Self-Healing Systems</h4>
						<h2>System Level: Time-To-Live (TTL)</h2>
						<img src="img/health/health-ttl.png">
					</section>
					<section id="health-ping">
						<h4>Self-Healing Systems</h4>
						<h2>System Level: Pings</h2>
						<img src="img/health/health-ping.png">
					</section>
					<section id="health-types">
						<h4>Self-Healing Systems</h4>
						<h2>Check Types</h2>
						<ul>
							<li class="fragment">Preventive</li>
							<li class="fragment">Reactive</li>
						</ul>
					</section>
					<section id="health-consul">
						<h4>Self-Healing Systems</h4>
						<h2>Consul Health Checks</h2>
						<img src="img/health/health-consul.png">
					</section>
					<section id="health-ansible-playbook">
						<h4>Self-Healing Systems</h4>
						<h2>Ansible Playbook</h2>
						<pre><code data-trim contenteditable>
cat /vagrant/ansible/swarm-healing.yml

cat /vagrant/ansible/roles/consul-healing/tasks/main.yml

cat /vagrant/ansible/roles/consul-healing/defaults/main.yml

cat /vagrant/ansible/roles/consul-healing/files/consul_check.json

cat /vagrant/ansible/roles/consul-healing/files/mem.sh

cat /vagrant/ansible/roles/consul-healing/files/disk.sh

cat /vagrant/ansible/roles/consul-healing/templates/watches.json

cat /vagrant/ansible/roles/consul-healing/templates/manage_watches.sh
						</code></pre>
					</section>
					<section id="health-ansible-run">
						<h4>Self-Healing Systems</h4>
						<h2>Ansible Playbook</h2>
						<pre><code data-trim contenteditable>
ansible-playbook /vagrant/ansible/swarm-healing.yml \
    -i /vagrant/ansible/hosts/prod
						</code></pre>
						Open <a href="http://10.100.192.200:8500/">http://10.100.192.200:8500/</a>
						<br />
						Open <a href="http://10.100.198.200:8080/job/hardware-notification/">http://10.100.198.200:8080/job/hardware-notification/</a>
					</section>
					<section id="health-automation">
						<h4>Self-Healing Systems</h4>
						<h2>Healing Automation</h2>
						<pre><code data-trim contenteditable>
cat /vagrant/ansible/roles/service-swarm/tasks/post-deployment.yml

cat /vagrant/ansible/roles/service-swarm/templates/consul_service.json

cat /vagrant/ansible/roles/service-redeploy/tasks/main.yml

ansible-playbook /vagrant/ansible/jenkins.yml \
    --extra-vars "service_job_template=service-config-healing.xml" \
    -c local
						</code></pre>
					</section>
					<section id="health-jenkins">
						<h4>Self-Healing Systems</h4>
						<h2>Jenkins</h2>
						Open <a href="http://10.100.198.200:8080/job/books-ms/configure">http://10.100.198.200:8080/job/books-ms/configure</a>
						<br />
						Open <a href="http://10.100.198.200:8080/job/books-ms/build">http://10.100.198.200:8080/job/books-ms/build</a>
						<br />
						Open <a href="http://10.100.198.200:8080/job/books-ms/lastBuild/console">http://10.100.198.200:8080/job/books-ms/lastBuild/console</a>
						<br />
						Open <a href="http://10.100.198.200:8080/job/books-ms-redeploy/configure">http://10.100.198.200:8080/job/books-ms-redeploy/configure</a>
					</section>
					<section id="health-stop-container">
						<h4>Self-Healing Systems</h4>
						<h2>Healing Services</h2>
						<pre><code data-trim contenteditable>
export DOCKER_HOST=tcp://10.100.192.200:2375

docker ps --filter name=books --format "table {{.Names}}"

docker stop $(docker ps | grep booksms_app | awk '{ print $1}')

docker ps --filter name=books --format "table {{.Names}}"

curl 10.100.192.200/api/v1/books | jq '.'

docker ps --filter name=books --format "table {{.Names}}"
						</code></pre>
						Open <a href="http://10.100.192.200:8500/ui/#/dc1/services/books-ms">http://10.100.192.200:8500/ui/#/dc1/services/books-ms</a>
						<br />
						Open <a href="http://10.100.198.200:8080/job/books-ms-redeploy/lastBuild/console">http://10.100.198.200:8080/job/books-ms-redeploy/lastBuild/console</a>
					</section>
					<section id="health-stop-node">
						<h4>Self-Healing Systems</h4>
						<h2>Healing Node Failure</h2>
						<pre><code data-trim contenteditable>
exit

vagrant halt swarm-node-2
						</code></pre>
						Open <a href="http://10.100.192.200:8500/ui/#/dc1/nodes">http://10.100.192.200:8500/ui/#/dc1/nodes</a>
						<br />
						Open <a href="http://10.100.192.200:8500/ui/#/dc1/services/books-ms">http://10.100.192.200:8500/ui/#/dc1/services/books-ms</a>
						<br />
						Open <a href="http://10.100.198.200:8080/job/books-ms-redeploy/lastBuild/console">http://10.100.198.200:8080/job/books-ms-redeploy/lastBuild/console</a>
					</section>
					<section id="health-check-node">
						<h4>Self-Healing Systems</h4>
						<h2>Check the Node</h2>
						<pre><code data-trim contenteditable>
vagrant ssh cd

export DOCKER_HOST=tcp://10.100.192.200:2375

docker info

docker ps --filter name=books --format "table {{.Names}}"

curl 10.100.192.200/api/v1/books | jq '.'

exit
						</code></pre>
					</section>
					<section id="health-up-node">
						<h4>Self-Healing Systems</h4>
						<h2>Bring Up the Node</h2>
						<pre><code data-trim contenteditable>
vagrant up swarm-node-2

vagrant ssh cd

ansible-playbook /vagrant/ansible/swarm-healing.yml \
    -i /vagrant/ansible/hosts/swarm \
    -vv

export DOCKER_HOST=tcp://10.100.192.200:2375

docker info

docker stop $(docker ps | grep booksms_app | awk '{ print $1}')

docker ps -a | grep books

curl 10.100.192.200:8500/v1/catalog/services \
    | jq '.'

curl 10.100.192.200/api/v1/books | jq '.'
						</code></pre>
					</section>
				</section>
				<section>
					<section id="logging">
						<h2>Centralized Logging</h2>
						<img src="img/logging/logging-logstash.png">
					</section>
					<section id="logging-ansible">
						<h4>Centralized Logging</h4>
						<h2>Ansible Playbook</h2>
						<pre><code data-trim contenteditable>
cat /vagrant/ansible/logging.yml

cat /vagrant/ansible/roles/elasticsearch/tasks/main.yml

cat /vagrant/ansible/roles/logstash/tasks/main.yml

cat /vagrant/ansible/roles/logstash/files/syslog.conf

cat /vagrant/ansible/roles/kibana/tasks/main.yml

cat /vagrant/ansible/roles/rsyslog/tasks/main.yml

cat /vagrant/ansible/roles/rsyslog/templates/10-logstash.conf
						</code></pre>
					</section>
					<section id="logging-ansible-run">
						<h4>Centralized Logging</h4>
						<h2>Running Ansible Playbook</h2>
						<pre><code data-trim contenteditable>
ansible-playbook /vagrant/ansible/logging.yml \
    -i /vagrant/ansible/hosts/prod
						</code></pre>
						Open <a href="http://10.100.192.200:5601">http://10.100.192.200:5601</a>.
					</section>
				</section>
				<section data-background="img/background/summary.png">
					<section id="summary">
						<h2>Say Again</h2>
						<ul>
							<li class="fragment"><label class="fragment grow highlight-current-green">Immutable</label> over mutable deployments</li>
							<li class="fragment"><label class="fragment grow highlight-current-green">Small</label> over big</li>
							<li class="fragment"><label class="fragment grow highlight-current-green">Automation</label> over manual procedures</li>
							<li class="fragment"><label class="fragment grow highlight-current-green">Service discovery</label> over predefined configuration</li>
							<li class="fragment"><label class="fragment grow highlight-current-green">Dynamic</label> over static</li>
							<li class="fragment"><label class="fragment grow highlight-current-green">Specialized</label> over do-it-all tools</li>
						</ul>
						<h4 class="fragment">
							That is, while there is value in the items on the <label class="fragment grow highlight-current-blue">right</label>, we value the items on the <label class="fragment grow highlight-current-green">left</label> more.
						</h4>
					</section>
				</section>
				<section id="qa" data-background="img/questions.jpg">
				</section>
				<section>
					<section id="the-end" data-background="img/the_end.jpg">
						<h1>Viktor Farcic</h1>
						<h3><a href="https://twitter.com/vfarcic">@vfarcic</a></h3>
						<h4><a href="http://technologyconversations.com">technology conversations.com</a></h4>
					</section>
				</section>
			</div>

		</div>

		<script src="../lib/js/head.min.js"></script>
		<script src="../js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: '../lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: '../plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: '../plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
//					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: '../plugin/zoom-js/zoom.js', async: true },
					{ src: '../plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
